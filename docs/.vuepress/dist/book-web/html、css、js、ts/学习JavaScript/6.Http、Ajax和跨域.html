<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.Http、Ajax和跨域 | Liawn&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <meta charset="UTF-8">
  <link rel="icon" href="/blog-vuepress/favicon.ico">
    <meta name="description" content="用vuepress搭建的个人博客">
    <meta charset="UTF-8">
    
    <link rel="preload" href="/blog-vuepress/assets/css/0.styles.5c52d671.css" as="style"><link rel="preload" href="/blog-vuepress/assets/js/app.0d2e1fde.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/2.a046c74e.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/31.f5f5fe9d.js" as="script"><link rel="prefetch" href="/blog-vuepress/assets/js/10.88d5532b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/100.a282e1e5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/101.1917817b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/102.426bef2e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/103.24a96e53.js"><link rel="prefetch" href="/blog-vuepress/assets/js/104.0b4b8196.js"><link rel="prefetch" href="/blog-vuepress/assets/js/105.98db5522.js"><link rel="prefetch" href="/blog-vuepress/assets/js/106.7a39c799.js"><link rel="prefetch" href="/blog-vuepress/assets/js/11.78e26b31.js"><link rel="prefetch" href="/blog-vuepress/assets/js/12.e39a10a3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/13.da0e53c1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/14.91a6c713.js"><link rel="prefetch" href="/blog-vuepress/assets/js/15.b9f3c2f3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/16.01c98a8e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/17.e733ec41.js"><link rel="prefetch" href="/blog-vuepress/assets/js/18.f4fea388.js"><link rel="prefetch" href="/blog-vuepress/assets/js/19.1d376bae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/20.4751d85a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/21.00437d3b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/22.64839502.js"><link rel="prefetch" href="/blog-vuepress/assets/js/23.7a4335d7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/24.3ee2b263.js"><link rel="prefetch" href="/blog-vuepress/assets/js/25.0767dbc8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/26.c416d882.js"><link rel="prefetch" href="/blog-vuepress/assets/js/27.5e82d924.js"><link rel="prefetch" href="/blog-vuepress/assets/js/28.24de79c4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/29.5a1e4f8e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/3.0b0dd8a7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/30.3c71597f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/32.eac572f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/33.660b2af0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/34.b6f9bd89.js"><link rel="prefetch" href="/blog-vuepress/assets/js/35.2e5e8650.js"><link rel="prefetch" href="/blog-vuepress/assets/js/36.04d6e910.js"><link rel="prefetch" href="/blog-vuepress/assets/js/37.4ffc07ec.js"><link rel="prefetch" href="/blog-vuepress/assets/js/38.f31deb49.js"><link rel="prefetch" href="/blog-vuepress/assets/js/39.5bd11cdb.js"><link rel="prefetch" href="/blog-vuepress/assets/js/4.6edbb2a1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/40.c0dc0955.js"><link rel="prefetch" href="/blog-vuepress/assets/js/41.32840955.js"><link rel="prefetch" href="/blog-vuepress/assets/js/42.afdf16b6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/43.04bbcb6b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/44.3f372036.js"><link rel="prefetch" href="/blog-vuepress/assets/js/45.199528f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/46.c23ffbe2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/47.33bc80d6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/48.c17f8a84.js"><link rel="prefetch" href="/blog-vuepress/assets/js/49.9f6c2490.js"><link rel="prefetch" href="/blog-vuepress/assets/js/5.c6c641ea.js"><link rel="prefetch" href="/blog-vuepress/assets/js/50.d6762688.js"><link rel="prefetch" href="/blog-vuepress/assets/js/51.1b65f46c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/52.d00b4d17.js"><link rel="prefetch" href="/blog-vuepress/assets/js/53.becdeb67.js"><link rel="prefetch" href="/blog-vuepress/assets/js/54.fe84cbfc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/55.42ca78e9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/56.38dc1cb5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/57.f4964e37.js"><link rel="prefetch" href="/blog-vuepress/assets/js/58.9b4d0044.js"><link rel="prefetch" href="/blog-vuepress/assets/js/59.cfb9c546.js"><link rel="prefetch" href="/blog-vuepress/assets/js/6.c6de6921.js"><link rel="prefetch" href="/blog-vuepress/assets/js/60.4f4f3658.js"><link rel="prefetch" href="/blog-vuepress/assets/js/61.e691fcda.js"><link rel="prefetch" href="/blog-vuepress/assets/js/62.fd6c77be.js"><link rel="prefetch" href="/blog-vuepress/assets/js/63.9acec8fc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/64.c6c33b9e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/65.30e05c43.js"><link rel="prefetch" href="/blog-vuepress/assets/js/66.fdb85611.js"><link rel="prefetch" href="/blog-vuepress/assets/js/67.4a8c9b0e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/68.cf4c210b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/69.b27adaff.js"><link rel="prefetch" href="/blog-vuepress/assets/js/7.4196f4e6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/70.a3316969.js"><link rel="prefetch" href="/blog-vuepress/assets/js/71.9eb46133.js"><link rel="prefetch" href="/blog-vuepress/assets/js/72.0fe4fe9a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/73.0bf36b4a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/74.fc2e628a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/75.205b56bf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/76.8c2bf9b9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/77.a0993252.js"><link rel="prefetch" href="/blog-vuepress/assets/js/78.41709f17.js"><link rel="prefetch" href="/blog-vuepress/assets/js/79.c8733b25.js"><link rel="prefetch" href="/blog-vuepress/assets/js/8.f87272cd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/80.f5ed5113.js"><link rel="prefetch" href="/blog-vuepress/assets/js/81.ddb61980.js"><link rel="prefetch" href="/blog-vuepress/assets/js/82.1d3482a9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/83.a28d44e2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/84.ce75ed5e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/85.d4ffd27c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/86.14ffaf35.js"><link rel="prefetch" href="/blog-vuepress/assets/js/87.482be605.js"><link rel="prefetch" href="/blog-vuepress/assets/js/88.c1035bd5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/89.e739598f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/9.0f96b506.js"><link rel="prefetch" href="/blog-vuepress/assets/js/90.5a928d71.js"><link rel="prefetch" href="/blog-vuepress/assets/js/91.82d05736.js"><link rel="prefetch" href="/blog-vuepress/assets/js/92.8c0f11ee.js"><link rel="prefetch" href="/blog-vuepress/assets/js/93.5cff49c0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/94.8ad61574.js"><link rel="prefetch" href="/blog-vuepress/assets/js/95.f849a0b0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/96.31401883.js"><link rel="prefetch" href="/blog-vuepress/assets/js/97.98310d37.js"><link rel="prefetch" href="/blog-vuepress/assets/js/98.f626e78b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/99.6891a17b.js">
    <link rel="stylesheet" href="/blog-vuepress/assets/css/0.styles.5c52d671.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><a href="/blog-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Liawn's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav></div></header> <div class="sidebar-wrapper sidebar-hidden"><aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><!----> <span>web前端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/" class="sidebar-heading clickable open"><span class="arrow down"></span> <span>学习JavaScript</span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/1.基础语法.html" class="sidebar-link">1.基础语法</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/2.变量、作用域和内存问题.html" class="sidebar-link">2.变量、作用域和内存问题</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/3.引用类型.html" class="sidebar-link">3.引用类型</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/4.面向对象程序设计.html" class="sidebar-link">4.面向对象程序设计</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/5.函数表达式.html" class="sidebar-link">5.函数表达式</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/6.Http、Ajax和跨域.html" class="active sidebar-link">6.Http、Ajax和跨域</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html" class="sidebar-link">7.异步编程</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/js零碎知识和案例.html" class="sidebar-link">js部分</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习CSS/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习CSS</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习TypeScript/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习TypeScript</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习Vue/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习Vue</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习React/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习React</span></a> <!----></section></li><li><a href="/blog-vuepress/book-web/web前端js框架/学习jQuery.html" class="sidebar-link">jQueryNote</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/LayaBox游戏引擎/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>H5游戏引擎Laya</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>数据结构与算法</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/数据结构与算法/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>数据结构与算法ts版</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>常用工具</span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/常用工具/Npm的使用.html" class="sidebar-link">Npm的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Git的使用.html" class="sidebar-link">Git的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/webpack的使用.html" class="sidebar-link">webpack的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/VSCode的使用.html" class="sidebar-link">VSCode的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Chrome的使用.html" class="sidebar-link">Chrome的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用docsify写blog.html" class="sidebar-link">使用docsify写blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用gitbook写blog.html" class="sidebar-link">使用gitbook写blog</a></li><li><a href="/blog-vuepress/book-web/web前端测试与调试/基于mocha+chai的单元测试.html" class="sidebar-link">使用mocha+chai进行单元测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>简单项目实践</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/项目/react+express+ts写爬虫/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>react+express+ts写爬虫</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>面试准备</span></p> <!----></section></li></ul> </aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div> <main class="page sidebar-hidden right-sidebar-hidden"> <div class="theme-default-content content__default"><h1 id="http、ajax和跨域"><a href="#http、ajax和跨域" class="header-anchor">#</a> Http、Ajax和跨域</h1> <h2 id="一、http请求概述"><a href="#一、http请求概述" class="header-anchor">#</a> 一、Http请求概述</h2> <h3 id="_1-1-输入一个url回车"><a href="#_1-1-输入一个url回车" class="header-anchor">#</a> 1.1 输入一个URL回车</h3> <p>在浏览器地址栏里输入一个URL然后按下回车，会发生以下事情：</p> <ul><li>DNS解析，建立TCP连接（三次握手），发送Http请求。</li> <li>server接收Http请求，处理并返回。</li> <li>客户端接收到返回数据后，处理数据（如渲染页面，执行js）。</li></ul> <h3 id="_1-2-简单说明"><a href="#_1-2-简单说明" class="header-anchor">#</a> 1.2 简单说明</h3> <p>打开浏览器，按下<code>F12</code>会打开浏览器控制台，查看控制台的<code>Network</code>页签。然后在浏览器地址栏里输入<code>www.baidu.com</code>并回车。</p> <ol><li><p>DNS解析：DNS（域名系统）拿到<code>https://www.baidu.com</code>，将它解析成一个<strong>IP地址</strong>，例如<code>180.101.49.11:443</code>。这个IP地址就是百度某个服务器的IP地址。<code>443</code>是https的默认端口，<code>80</code>是http默认端口。DNS解析是DNS客户端向DNS服务器端发送一份查询报文也就是域名等，DNS服务器端会返回一份报文也就是IP地址等。</p> <p><img src="/blog-vuepress/assets/img/DNS解析.1f415d17.png" alt="DNS解析"></p></li> <li><p>建立TCP连接：也就是三次握手。第一次握手，客户端询问服务端“你是否可用”；第二次握手，服务端告知客服端“我可用”；第三次握手，客户端告知服务端“我即将访问你”。</p></li> <li><p>发送Http请求：大多发送的是GET或者POST请求，可以是URL直链请求也可以使用ajax异步发送请求。</p></li> <li><p>server处理请求：确认访问权限，处理好业务逻辑之后会返回响应。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// node.js处理请求</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'req.method'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'req.url'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>接收响应：客户端处理响应，比如加载返回的js、css文件并执行它们。</p></li></ol> <h2 id="二、xmlhttprequest对象"><a href="#二、xmlhttprequest对象" class="header-anchor">#</a> 二、XMLHttpRequest对象</h2> <h3 id="_2-1-xhr的使用"><a href="#_2-1-xhr的使用" class="header-anchor">#</a> 2.1 XHR的使用</h3> <p><strong>Ajax</strong>是<code>Asynchronous JavaScript And XML</code>的缩写，表示<strong>异步</strong>的JavaScript+XML。Ajax是一门浏览器与服务器的<strong>通信技术</strong>，它的特点是<strong>无需刷新页面</strong>即可从服务器取得数据（请求然后响应最后修改DOM，无需刷新页面），它的核心是<strong>XMLHttpRequest对象</strong>（简称XHR），前端人员可以使用这个对象进行服务器数据请求。需要注意的是，它名称虽然包含XML，但其实与数据格式无关（可能是纯文本、XML、JSON）。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 先实例化它，原生XMLHttpRequest，没有参数</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>实例化XMLHttpRequest之后，我们就可以准备发送一个<strong>请求</strong>了，先<strong>配置</strong>请求信息（仅配置），再<strong>发送</strong>请求（建立连接）。</p> <ul><li>使用<code>xhr.open()</code>进行<strong>配置</strong>。该方法接收三个参数，第一个参数是什么类型的请求，比如是<code>&quot;GET&quot;</code>还是<code>&quot;POST&quot;</code>（最好都大写）；第二个参数是请求地址，比如<code>http://localhost/test.txt</code>；第三个参数是是否异步发送请求，一般是<code>true</code>（可以不传，默认值就是<code>true</code>）。</li> <li><strong>发送</strong>请求使用<code>xhr.send(param)</code>，GET请求是没有<code>param</code>的，POST是有<code>param</code>的，<code>param</code>是请求主体发送的数据（request body）。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 配置请求信息</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost/test.txt&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送请求。GET是没有param，POST是有param的，param是request body</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>发送请求过后，因为一般是异步的，所以我们要知道请求/响应到了<strong>什么阶段</strong>，xhr的<code>readyState</code>属性就<strong>记录</strong>这些信息：</p> <ul><li><code>0</code>：未初识化。尚未调用<code>open()</code>方法。常定义<code>UNSENT = 0; // 初始状态</code>。</li> <li><code>1</code>：启动。已经调用<code>open()</code>方法，但尚未调用<code>send()</code>方法。常定义<code>OPENED = 1; // open被调用</code>。</li> <li><code>2</code>：发送。已经调用<code>send()</code>方法，但尚未接收到响应。常定义<code>HEADERS_RECEIVED = 2; // 接收到response header</code>。</li> <li><code>3</code>：接收。已经接收到部分响应数据。常定义<code>LOADING = 3; // 响应正在被加载</code>。</li> <li><code>4</code>：完成。已经接收到全部响应数据。常定义<code>DONE = 4; // 请求完成</code>。</li></ul> <p>并且<code>readyState</code>的值<strong>每次变化</strong>时都会触发<code>readystatechange</code>事件。那前端人员就可以<strong>监听</strong>这个事件，再配合<code>readyState</code>的为<code>4</code>，就可以判断何时去<strong>处理响应</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 已经接收到全部响应数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理响应</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>浏览器收到服务器的响应后，会<strong>填充</strong>XHR对象的<strong>属性</strong>。相关属性如下：</p> <ul><li><code>responseText</code>（新脚本是<code>response</code>）：作为响应主体被返回的文本（不管什么数据类型）。</li> <li><code>responseXML</code>（这是旧脚本）：如果响应的内容类型是<code>text/xml</code>或<code>application/xml</code>，这个属性中将保存包含着响应数据的<code>XML DOM</code>文档。</li> <li><code>status</code>：响应额HTTP状态。</li> <li><code>statusText</code>：HTTP状态的说明，作为参考，一般不作为后续js判断。</li></ul> <p>前端人员需要在响应返回后，拿到这个XHR对象做校验和业务逻辑处理（<strong>处理响应</strong>）。校验就是判断<strong>状态码</strong>也就是<code>status</code>属性，是<code>[200, 300)</code>以及<code>304</code>都是这次请求成功的标志。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// `[200, 300)`以及`304`是请求成功</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span><span class="token number">300</span> <span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Request was unsuccessful: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果在接收响应前想取消异步请求（终止请求），可以使用<code>xhr.abort()</code>方法，来停止XHR对象的事件触发，并且不能访问到<strong>与响应有关的属性</strong>。</p> <p>因为技术的进步，<code>responseText</code>和<code>responseXML</code>都比较老旧了，它们常被<code>response</code>替代，并且还常使用<code>xhr.responseType</code>来<strong>设置响应格式</strong>：</p> <ul><li><code>&quot;&quot;</code>：同<code>&quot;text&quot;</code>。</li> <li><code>&quot;text&quot;</code>：response是DOMString对象中的文本。</li> <li><code>&quot;arraybuffer&quot;</code>：response是一个包含二进制数据的ArrayBuffer。</li> <li><code>&quot;blob&quot;</code>：response是一个包含二进制数据的Blob对象。</li> <li><code>&quot;document&quot;</code>：response 是一个 HTML Document 或 XML XMLDocument，根据接收到的数据的MIME类型而定。</li> <li><code>&quot;json&quot;</code>：response是通过将接收到的数据内容解析为JSON，从而创建js对象。</li></ul> <p>这一节最后，我们写一个<strong>比较完整</strong>的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 配置请求信息</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 配置请求信息</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/blog/xmlhttprequest/json&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置响应格式，我们用常用的json格式</span>
xhr<span class="token punctuation">.</span>responseType <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">;</span>
<span class="token comment">// 发送请求。GET是没有param</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 监听readystate的变化，readystate为4去处理响应</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// readystate为4，表示已经接收到全部响应数据，可以开始处理响应信息了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readystate <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 响应状态码status为[200, 300)以及304是请求成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span><span class="token number">300</span> <span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 写法一，这是旧脚本的写法</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.responseText'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 写法二，这是新脚本的写法，返回的是json并且还转为了js对象</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.response'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'Request was unsuccessful: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_2-2-进度事件"><a href="#_2-2-进度事件" class="header-anchor">#</a> 2.2 进度事件</h3> <p>进度事件（Progress Events）定义了与客户端服务器通信有关的事件：</p> <ul><li><code>progress</code>：在接收响应期间持续不断地触发。例如下载进度。</li> <li><code>error</code>：在请求发生错误时触发。例如网络中断或者无效的URL。</li> <li><code>load</code>：在接收到完整的响应数据时触发。即使<code>xhr.status</code>为<code>400</code>或<code>500</code>等。</li> <li><code>abort</code>：在因为调用<code>abort()</code>方法而终止连接时触发。</li> <li><code>loadstart</code>：在接收到响应数据的第一个字节时触发。</li> <li><code>loadend</code>：在通信完成或触发<code>error</code>、<code>abort</code>或<code>load</code>事件后触发。</li> <li><code>timeout</code>：请求超时。可以在请求发送前设置<code>xhr.timeout=30000</code>。</li></ul> <p>前三个用的比较多，也经常使用<code>load</code>事件来<strong>替代</strong><code>readystatechange</code>事件，当然内部还是继续搭配<code>xhr.status</code>状态码判断返回结果。</p> <p><code>progress</code>常用作<strong>进度指示器</strong>，监听的回调函数有个event参数，他有三个参数，<code>lengthComputable</code>、<code>position</code>和<code>totalSize</code>，分别表示“进度信息是否可用”、“已接收的字节数”和“根据Content-Length响应头部确定的预期字节数”。<strong>后两个参数</strong>在现如今的js中应该是<code>loaded</code>和<code>total</code>了（意思还是一样的），<code>position</code>和<code>totalSize</code>可能或许还会存在。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 下载一个文件</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'/blog/xmlhttprequest/load'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 请求收到了完整的响应</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 写法一，这是旧脚本的写法</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.responseText'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写法二，这是新脚本的写法</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.response'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.status'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.statusText'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 接收响应期间一直不断的触发该事件</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 写法一，这是旧脚本的写法</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>position<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>totalSize<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写法二，这是新脚本的写法</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> bytes</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 请求失败，断网或者URL错误</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Request failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_2-3-头部信息和post请求"><a href="#_2-3-头部信息和post请求" class="header-anchor">#</a> 2.3 头部信息和POST请求</h3> <p>每个HTTP请求和响应都会带有一个<strong>头部信息</strong>（请求头部和响应头部），我们来<strong>了解</strong>一下<strong>默认的</strong>浏览器头部信息：</p> <ul><li><code>Accept</code>：浏览器能够处理的内容类型。</li> <li><code>Accept-Charset</code>：浏览器能够显示的字符集。</li> <li><code>Accept-Encoding</code>：浏览器能够处理的压缩编码。</li> <li><code>Accept-Language</code>：浏览器当前设置的语言。</li> <li><code>Connection</code>：留恋其与服务器之连接的类型。</li> <li><code>Cookie</code>：当前页面设置的任何Cookie。</li> <li><code>Host</code>：发出请求的页面所在域。</li> <li><code>Refere</code>：发出请求的页面的URI。（HTTP规范拼错了单词，本来应该是referre，以规范为主）</li> <li><code>User-Agent</code>：浏览器的用户代理字符串。</li></ul> <p>我们<strong>不建议修改默认的浏览器头部信息</strong>，但可以使用自定义的头部信息，<code>xhr.setRequestHeader(xxx, yyyy)</code>，xxx是字段名，yyy是值。要注意的是<code>setRequestHeader()</code>方法必须得在<code>open()</code>和<code>send()</code>之间使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;http://localhost/test.txt&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'MyHeader'</span><span class="token punctuation">,</span> <span class="token string">'MyValue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们可以获取响应头部信息，使用<code>xhr.getResponseHeader(xxx)</code>获取单个，<code>xhr.getAllResponseHeader()</code>获取全部响应头部信息。</p> <p><strong>GET请求</strong>，是将<strong>简单传参数据</strong>放到了URL的<strong>末尾</strong>，但必须经过<code>encodeURIComponent()</code>进行<strong>编码</strong>之后才能放到URL的末尾，所有的<strong>键值对儿</strong>都必须由<code>&amp;</code>进行分隔。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'example.php?name1=value1&amp;name2=value2&amp;name3=value3'</span>， <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 向现有URL的末尾添加查询字符串参数</span>
<span class="token keyword">function</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 含有?那就追加&amp;，还不含有?那就加追?</span>
    url <span class="token operator">+=</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'?'</span> <span class="token operator">:</span> <span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加?或&amp;就可以添加键值对儿了</span>
    url <span class="token operator">+=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> url<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>POST请求</strong>，是将<strong>较为复杂数据</strong>作为了<strong>请求的主体</strong>提交的，这些数据大概率会被服务器保存，属于<strong>重要数据</strong>。这些数据是放在<code>send()</code>的入参里，数据格式通常是<code>multipart/form-data</code>、<code>JSON</code>、<code>XML</code>。</p> <p>特别注意，很久以前的<strong>表单数据</strong>传递要设置<code>xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')</code>。而在后来，定义了一个新类型<strong>FormData</strong>，简化了表单数据序列化，也不用再<strong>手动设置</strong><code>Content-Type</code>头部信息。</p> <p>FormData方式（其实就是<code>multipart/form-data</code>）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// FormData序列化表单，创建与表单格式相同的数据</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>forms<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 追加新的键值对</span>
data<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;JavaScript&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;example.php&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用FormData后无需设置Content-Type头部信息</span>
<span class="token comment">// xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');</span>
<span class="token comment">// 发送请求</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>JSON</code>形式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 转为json字符串</span>
<span class="token keyword">var</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 这里不要忘了，这不同于FormData，这个得手动设置</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json; charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2-4-上传"><a href="#_2-4-上传" class="header-anchor">#</a> 2.4 上传</h3> <p><strong>上传</strong>请求比较特殊，它的上传进度不是<code>xhr.onprogress</code>而是<code>xhr.upload.onprogress</code>，并且其他常用的事件都是在<code>xhr.upload</code>上。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 文件上传 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">onchange</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value javascript language-javascript"><span class="token function">upload</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">function</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 上传进度</span>
            xhr<span class="token punctuation">.</span>upload<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Uploaded </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>loaded<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> of </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 请求收到了完整的响应</span>
            xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.response'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.status'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'xhr.statusText'</span><span class="token punctuation">,</span> xhr<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 请求失败</span>
            xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Request failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/blog/xmlhttprequest/upload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="三、跨域资源共享"><a href="#三、跨域资源共享" class="header-anchor">#</a> 三、跨域资源共享</h2> <h3 id="_3-1-cors"><a href="#_3-1-cors" class="header-anchor">#</a> 3.1 CORS</h3> <p>使用Ajax技术有个<strong>限制</strong>，那就是<strong>不能跨域</strong>进行请求（跨域也叫跨源），它只能访问相同<strong>域名</strong>、相同<strong>端口</strong>、相同<strong>协议</strong>的资源（同源）。</p> <p><strong>CORS</strong>（Cross-Origin Resource Sharing）是由W3C推出的一个<strong>基于HTTP头部</strong>的<strong>跨域资源共享</strong>技术。CORS新增了一组的HTTP头部字段，存储着<strong>预检请求信息</strong>或<strong>源信息</strong>；CORS也让服务器声明了哪些<strong>源站</strong>有权访问哪些资源（判断标准），接收请求时服务器会拿到<strong>源信息</strong>，并以这个标准作为<strong>判断依据</strong>；另外，对于非简单请求会先进行<strong>预检</strong>，拿到<strong>预检请求信息</strong>判断是否安全标准，在通过预检后才能进行<strong>实际</strong>的跨域请求。</p> <h3 id="_3-2-简单请求"><a href="#_3-2-简单请求" class="header-anchor">#</a> 3.2 简单请求</h3> <p>大多浏览器是通过<strong>XMLHttpRequest对象</strong>实现了对CORS的<strong>原生支持</strong>。如果要检测浏览器的XHR是否支持CORS，可以检测XHR对象上是否具有<code>withCredentials</code>属性（不支持IE10以及以前版本）。</p> <p><strong>简单请求</strong>：请求方法要较为<strong>简单</strong>，自定义的头部信息较为<strong>安全</strong>和<strong>标准</strong>。也就是大部分情况满足下面条件即可（少部分去MDN查）：</p> <ul><li>使用较为简单的请求方法，<code>GET</code>或<code>HEAD</code>或<code>POST</code>。</li> <li>自定义头部字段<code>Accept</code>、<code>Accept-Language</code>、<code>Content-Language</code>、<code>Content-Type</code>，这些字段的值要<strong>安全</strong>和<strong>标准</strong>。
<ul><li>其中<code>Content-Type</code>字段值<strong>必须</strong>是<code>text/plain</code>、<code>multipart/form-data</code>、<code>application/x-www-form-urlencoded</code>之一。</li> <li>至于<code>Accept</code>、<code>Accept-Language</code>和<code>Content-Language</code>是什么标准，可以查：<a href="https://bugs.webkit.org/show_bug.cgi?id=165178" target="_blank" rel="noopener noreferrer">网站1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://bugs.webkit.org/show_bug.cgi?id=165566" target="_blank" rel="noopener noreferrer">网站2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://bugs.webkit.org/show_bug.cgi?id=166363" target="_blank" rel="noopener noreferrer">网站3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul></li></ul> <p><strong>简单请求</strong>的HTTP头部有个非常重要的<strong>源信息</strong>，它是存储在<code>Origin</code>字段里，它包含了<strong>请求页面</strong>的<strong>域名</strong>、<strong>端口</strong>和<strong>协议</strong>信息。如果服务器成功通过了这个请求，会在<strong>响应头部</strong>里使用<code>Access-Control-Allow-Origin</code><strong>回发</strong>相同的<strong>源信息</strong>；如果访问的是公共资源，能被任意外域访问，那<code>Access-Control-Allow-Origin</code>得值就是<code>'*'</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检测XHR是否支持CORS，只需判断对象上是否有withCredentials属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'withCredentials'</span> <span class="token keyword">in</span> xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这是一个简单请求</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://bar.other/resources/public-data/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>上面这个例子的简单请求的请求/响应报文可能如下：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code>// 请求报文
GET /resources/public-data/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
Referer: http://foo.example/examples/access-control/simpleXSInvocation.html
Origin: http://foo.example   // 请求的头部信息

// 响应报文
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 00:23:53 GMT
Server: Apache/2.0.61
Access-Control-Allow-Origin: *  // 访问的是公共资源
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Transfer-Encoding: chunked
Content-Type: application/xml

[XML Data]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_3-3-非简单请求"><a href="#_3-3-非简单请求" class="header-anchor">#</a> 3.3 非简单请求</h3> <p><strong>非简单请求</strong>就是除了上一节的<strong>简单请求</strong>以外的一些<strong>特殊HTTP请求</strong>，比如使用PATCH方法、DELETE方法、MIME类型的POST方法等。对于非简单请求，浏览器会先使用<strong>OPTIONS方法</strong>对服务器发起一个<strong>预检请求</strong>，服务器对<strong>预检请求信息</strong>进行检查（因为这类请求比简单请求不安全不标准，所以要预检），预检通过后服务器才会允许<strong>该源站</strong>发送<strong>实际</strong>的跨源请求（那就可以继续进行<strong>非简单请求</strong>了），并且还告知该源站以后<strong>是否</strong>需要携带身份<strong>凭证</strong>（HTTP认证相关数据和cookie）。</p> <p><strong>预检请求</strong>的头部里依然有<code>Origin</code>，除了<code>Origin</code>还有两个重要字段<code>Access-Control-Request-Method</code>和<code>Access-Control-Request-Headers</code>。</p> <ul><li><code>Access-Control-Request-Method</code>是告知服务器之后的实际跨域请求将使用什么<strong>方法</strong>（PATCH？POST？）。</li> <li><code>Access-Control-Request-Headers</code>是告知服务器之后的实际跨域请求将携带什么<strong>自定义</strong>请求<strong>头部字段</strong>。</li></ul> <p>同样，服务器成功通过预检请求后，返回给浏览器的<strong>响应头部</strong>除了有<code>Access-Control-Allow-Origin</code>之外，还有三个重要字段：</p> <ul><li><code>Access-Control-Allow-Methods</code>: 表明服务器允许客户端使用哪些方法。</li> <li><code>Access-Control-Allow-Headers</code>: 表明服务器允许携带那些<strong>自定义</strong>请求<strong>头部字段</strong>。</li> <li><code>Access-Control-Max-Age</code>: 是一个秒单位的数值，表明该<strong>非简单请求</strong>在这个时间内<strong>不用</strong>进行<strong>第二次预检</strong>了。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检测XHR是否支持CORS，只需判断对象上是否有withCredentials属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'withCredentials'</span> <span class="token keyword">in</span> xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 自定义了两个头部字段，并会体现在`Access-Control-Request-Headers`字段里</span>
        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'X-PINGOTHER'</span><span class="token punctuation">,</span> <span class="token string">'pingpong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/xml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这是一个非简单请求</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://bar.other/resources/post-here/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;?xml version=&quot;1.0&quot;?&gt;&lt;person&gt;&lt;name&gt;Arun&lt;/name&gt;&lt;/person&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>预检</strong>的请求/响应报文</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>// 请求报文
OPTIONS /resources/post-here/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
// 源信息
Origin: http://foo.example
// 告知服务器，之后实际跨域请求，它使用的是POST方式
Access-Control-Request-Method: POST
// 告知服务器，之后实际跨域请求里，我会携带X-PINGOTHER和Content-Type这两个自定义头部字段
Access-Control-Request-Headers: X-PINGOTHER, Content-Type

// 响应报文
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache/2.0.61 (Unix)
// 源信息
Access-Control-Allow-Origin: http://foo.example
// 告知客户端，之后实际跨域请求可使用POST、GET、OPTIONS方法
Access-Control-Allow-Methods: POST, GET, OPTIONS
// 告知客户端，之后实际跨域请求可携带X-PINGOTHER和Content-Type这两个自定义头部字段
Access-Control-Allow-Headers: X-PINGOTHER, Content-Type
// 告知客户端，该非简单请求在24小时内不用进行第二次预检了
Access-Control-Max-Age: 86400
Vary: Accept-Encoding, Origin
Content-Encoding: gzip
Content-Length: 0
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Content-Type: text/plain
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>之后的实际<strong>跨域</strong>请求/响应报文：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>POST /resources/post-here/ HTTP/1.1
Host: bar.other
User-Agent: Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; rv:1.9.1b3pre) Gecko/20081130 Minefield/3.1b3pre
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7
Connection: keep-alive
X-PINGOTHER: pingpong
Content-Type: text/xml; charset=UTF-8
Referer: http://foo.example/examples/preflightInvocation.html
Content-Length: 55
Origin: http://foo.example
Pragma: no-cache
Cache-Control: no-cache

&lt;?xml version=&quot;1.0&quot;?&gt;&lt;person&gt;&lt;name&gt;Arun&lt;/name&gt;&lt;/person&gt;


HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:40 GMT
Server: Apache/2.0.61 (Unix)
Access-Control-Allow-Origin: http://foo.example
Vary: Accept-Encoding, Origin
Content-Encoding: gzip
Content-Length: 235
Keep-Alive: timeout=2, max=99
Connection: Keep-Alive
Content-Type: text/plain

[Some GZIP'd payload]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="_3-4-带凭据的请求"><a href="#_3-4-带凭据的请求" class="header-anchor">#</a> 3.4 带凭据的请求</h3> <p>默认情况下，对于跨域XMLHttpRequest请求，浏览器<strong>不会</strong>发送<strong>身份凭证信息</strong>。如果要发送（预检结果告诉你下次请求要带凭证），可以将<code>withCredentials</code>属性设置为true，让请求携带凭证信息传给服务器。服务器也接收带凭证的请求，会将<code>Access-Control-Allow-Credentials:true</code>添加到响应头部信息里。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检测XHR是否支持CORS，只需判断对象上是否有withCredentials属性</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'withCredentials'</span> <span class="token keyword">in</span> xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> isAsyn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发送的请求里携带了身份凭证信息</span>
        xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://bar.other/resources/credentialed-content/'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    request<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>而浏览器发的请求带了凭证，但服务器没有<code>Access-Control-Allow-Credentials</code>，那最终js会获取不到这个响应信息（response为空），并会触发onerror事件。</p> <h2 id="四、其他跨域技术"><a href="#四、其他跨域技术" class="header-anchor">#</a> 四、其他跨域技术</h2> <h3 id="_4-1-图像ping"><a href="#_4-1-图像ping" class="header-anchor">#</a> 4.1 图像Ping</h3> <p>一个网页可以从<strong>任何</strong>网页中<strong>加载图像</strong>，不用担心跨域问题。<strong>动态创建图像</strong>，使用它们的onload和onerror事件处理程序是否接收到响应。</p> <p>动态创建图像常使用<strong>图像Ping</strong>，请求的数据是通过查询字符串形式发送的，而响应可以是任意内容（通常是像素图或204响应）。不过它<strong>只能发送GET请求</strong>，无法访问服务器的<strong>响应文本</strong>，也就是说它是<strong>单向的数据传输</strong>。</p> <p>通过图像Ping，浏览器得不到任何具体的数据，但通过侦听load和error事件，它能知道响应是什么时候接收到的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
img<span class="token punctuation">.</span>onload <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Done!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 发送了一个name参数，图像Ping常用于跟踪用户点击次数</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://www.example.com/test?name=Nicholas&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_4-2-jsonp"><a href="#_4-2-jsonp" class="header-anchor">#</a> 4.2 JSONP</h3> <p><strong>JSONP</strong>（JSON with padding）是填充式JSON或参数式JSON，讲一个回调函数追加到跨域访问的地址后面，再这个字符串放到<code>&lt;scipt&gt;</code>标签的<code>src</code>属性里，在页面加载这个<code>&lt;script&gt;</code>时（和<strong>图像Ping</strong>类似，可从任何网址加载脚本），会对服务器发起请求，当响应达到时，回调函数会被触发，回调函数里的参数就是response响应数据。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response.ip'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response.city'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'response.region_name'</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>region_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">reateElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将jsonp放入到跨域地址后面</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">&quot;http://freegeoip.net/json?callback=handleResponse&quot;</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>JSONP</strong>相比于<strong>图像Ping</strong>类，它能够直接访问响应文本（response），是<strong>双向</strong>的。但如果服务器不安全，响应中可能夹带恶意代码；还有确定JSONP请求<strong>是否失败</strong>并不容易，有可能需要定时器来监视。</p> <h3 id="_4-3-comet"><a href="#_4-3-comet" class="header-anchor">#</a> 4.3 Comet</h3> <p>Ajax是页面向服务器<strong>请求</strong>数据，而<strong>Comet</strong>是一种服务器向页面<strong>推送</strong>数据的技术。<strong>Comet</strong>（服务器推送）有两种实现：<strong>长轮询</strong>和<strong>流</strong>。</p> <p><strong>短轮询</strong>（也叫常规轮询），浏览器定期发送<strong>请求</strong>给服务器，服务器会将<strong>目前为止的数据</strong>作为响应传递给浏览器（不管该数据是否有效）。服务器会一直被动接收请求，还得必须作出响应，尽管可能是无效的响应，这非常消耗服务器的性能。</p> <p><img src="data:image/png;base64,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" alt="短轮询"></p> <p>而<strong>长轮询</strong>，浏览器发送一个请求，服务器虽然始终处于<strong>连接打开</strong>，但是没有新数据是不会推送数据给浏览器，直到有新数据可发送才会去<strong>推送</strong>。服务器掌握了主动权，只发送有效的数据，这很节省服务器资源。无论是短轮询还是长轮询，浏览器在接收数据之前，都会<strong>先发起</strong>对服务器的连接。</p> <p><img src="data:image/png;base64,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" alt="长轮询"></p> <p><strong>流</strong>就是HTTP流，它在页面的整个生命周期内<strong>只</strong>使用<strong>一个</strong>HTTP连接。浏览器向服务器发送一个请求，服务器就会一直保持连接打开，并周期性向浏览器推送数据。（长轮询本质还是一个个HTTP连接，流就只有一个，且readyState大部分时间是<code>3</code>）。<strong>流</strong>常用于服务器将输出缓存内容一次性全部发送给客户端。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createStreamingClient</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> finished</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> received <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 处理了多少个字符</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> result<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>received<span class="token punctuation">)</span><span class="token punctuation">;</span>
            received <span class="token operator">+=</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 每次递增</span>
            <span class="token function">progress</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">finished</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> xhr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">createStreamingClient</span><span class="token punctuation">(</span><span class="token string">'streaming.php'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Received：&quot;</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Done!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>管理Comet连接是很容易出错的，随着时间的推移，社区为Comet提供了两个新的API来完善以前的问题。</p> <h3 id="_4-4-服务器发送事件"><a href="#_4-4-服务器发送事件" class="header-anchor">#</a> 4.4 服务器发送事件</h3> <p><strong>SSE</strong>（Serve-Sent Events，服务器发送事件）是用于创建服务器到浏览器的<strong>单向连接</strong>，服务器可以通过这个连接发送任意数量的数据。服务器响应的MIME类型必须是<code>text/event-strean</code>，而且数据输出要能被js的API解析。</p> <p>使用<strong>SSE</strong>时要订阅新的事件流，实例化EventSource，并将一个URL作为<strong>第一个</strong>参数，如果要<strong>跨域</strong>那<strong>第二参数</strong>应该是<code>{withCredentials: true}</code>。</p> <p>EventSource实例对象有个<code>readyState</code>属性，值为<code>0</code>表示正在连接，<code>1</code>表示连接成功，<code>2</code>表示连接关闭了。如果你非要<strong>关闭连接</strong>，可以使用<code>close()</code>方法，但是你想<strong>重新使用</strong>EventSource，只能<strong>重新实例化</strong>EventSource（订阅新的事件流）。</p> <p>EventSource还有三个事件：</p> <ul><li><code>open</code>：在建立连接时触发。</li> <li><code>message</code>：在从服务器接收到新事件时触发，事件回调有个<code>event</code>参数，该参数有个<code>data</code>属性，该属性就是服务器返回的数据（字符串）。</li> <li><code>eror</code>：在无法建立连接时触发。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 异步的EventSource</span>
<span class="token keyword">let</span> eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">&quot;/events/subscribe&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">withCredentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
eventSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// json形式的：{&quot;user&quot;:&quot;Bob&quot;,&quot;message&quot;:&quot;First line\n Second line&quot;}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>响应格式可能是纯文本的，最简单的情况是<strong>每个数据项</strong>都带有前缀<code>data:</code>，例如：</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>data: foo

data: bar

data: foo
data: bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面这样的文本，在之前代码的<code>console.log(&quot;message&quot;, event.data)</code>，会输出三次，第一次是<code>foo</code>，第二次是<code>bar</code>，第三次是<code>foo\nbar</code>。<code>data:</code>是相邻两行，那么它们将作为一条message返回，中间会插入<code>\n</code>换行符（对应服务器生成流时也只用一个<code>\n</code>）。如果<code>data:</code>之间有空行，它们会作为两条message返回（对应服务器生成流时用两个<code>\n</code>）。</p> <p>SSE<strong>支持</strong>短轮询、长轮询和HTTP流，而且能在断开连接时<strong>自动确定</strong>何时重新连接，服务器可设置延迟响应时间<code>retry: 3000</code>。</p> <p>为了正确地重新连接，每一条消息都应设置一个id，具体是通过前缀<code>id:</code>来给message添加id的，这个<code>id: 1</code>紧挨着<code>data:</code>上一行或下一行都可以。而浏览器收到带有id的message时，EventSource实例对象会有个<code>lastEventId</code>属性，它就是id的具体值。</p> <div class="language-txt line-numbers-mode"><pre class="language-txt"><code>id: 1
data: foo

data: bar
id: 2

id: 3
data: foo
data: bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果断开连接，会向服务器发送一个包含<code>Last-Event-ID</code>字段的特殊头部的请求，以便服务器知道下一次该触发哪个事件（保证浏览器能接收到顺序正确的数据）。</p> <h3 id="_4-5-web-socket"><a href="#_4-5-web-socket" class="header-anchor">#</a> 4.5 Web Socket</h3> <p><strong>Web Socket</strong>是在一个单独的<strong>持久连接</strong>上提供<strong>全双工、双向通信</strong>，http协议升级到web socket协议（服务器要使用专门支持这种协议的服务器）。未加密的连接不再是<code>http://</code>而是<code>ws://</code>；加密连接也不再是<code>https://</code>而是<code>wss//</code>。</p> <p>可以对比一下WebSocket和EventSource：</p> <table><thead><tr><th>WebSocket</th> <th>EventSource</th></tr></thead> <tbody><tr><td>双向：客户端和服务端都能交换消息</td> <td>单向：仅服务端能发送消息</td></tr> <tr><td>二进制和文本数据</td> <td>仅文本数据</td></tr> <tr><td>WebSocket 协议</td> <td>常规 HTTP 协议</td></tr></tbody></table> <p>WebSocket协议能让客户端与服务端之间发送非常少量的数据，而不用担心HTTP那样字节级的开销。由于WebSocket传递的<strong>数据包很小</strong>，所以它非常<strong>适合移动应用</strong>，可以最大程度解决宽带和网络延迟的问题。</p> <p>使用WebSocket，得先实例化WebSocket，并传入连接的URL。同源策略对WebSocket不适用（<strong>没有跨域限制</strong>），因此可以通过它打开任何站点的连接。</p> <p>实例化WebSocket后，浏览器会立马尝试创建连接。WebSocket实例对象也有一个<code>readyState</code>属性：</p> <ul><li><code>WebSocket.CONNECTING</code>，值是<code>0</code>：正在建立连接</li> <li><code>WebSocket.OPEN</code>，值是<code>1</code>：已经建立连接</li> <li><code>WebSocket.CLOSING</code>，值是<code>2</code>：正在关闭连接</li> <li><code>WebSocket.CLOSED</code>，值是<code>3</code>：已经关闭连接</li></ul> <p>WebSocket还有4个事件：</p> <ul><li><code>open</code>：在成功建立连接时触发。</li> <li><code>message</code>：在接收到数据时触发。</li> <li><code>error</code>：在发生错误时触发，连接不能持续了。</li> <li><code>close</code>：在连接关闭时触发。</li></ul> <p>使用WebSocket发送数据是<code>send(param)</code>方法，param就是要发送的数据，param只能是<strong>纯文本</strong>，如果是<strong>对象</strong>就要使用<code>JSON.stringify(param)</code>进行转换（序列化）。使用WebSocket接收数据，在<code>message</code>事件的回调函数中，该函数的参数<code>event</code>，这个<code>event</code>的<code>data</code>属性就是返回数据，该数据是穿文本字符串，一般使用前要经过<code>JSON.parse()</code>进行转换。</p> <p>一个较为完整的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;wss://www.example.com/server.php&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接已建立</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为连接的建立是异步的，所以得保证连接建立了才发送请求。</span>
    <span class="token comment">// 如果参数是对象，要转换为JSON字符串</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Bob'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 接收到数据</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的event.data是JSON字符串，需要转换为对象</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到数据：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 连接关闭，当我们不再使用WebSocket可以关闭它：socket.close([code], [reason])</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>wasClean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 正常关闭，code一般为1000</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WebSocket连接正常关闭， code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reason=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 服务器进程被杀死或网络中断，event.code 通常为 1006</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WebSocket连接丢失， code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> reason=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 连接发生错误</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">WebSocket发生了错误：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/6/2022, 3:41:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/5.函数表达式.html" class="prev">
        5.函数表达式
      </a></span> <span class="next"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html">
        7.异步编程
      </a>
      →
    </span></p></div> </main> <div class="right-sidebar-wrapper right-sidebar-hidden"><aside class="right-sidebar"><ul><h4>本文目录</h4></ul></aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div></div><div class="global-ui"></div></div>
    <script src="/blog-vuepress/assets/js/app.0d2e1fde.js" defer></script><script src="/blog-vuepress/assets/js/2.a046c74e.js" defer></script><script src="/blog-vuepress/assets/js/31.f5f5fe9d.js" defer></script>
  </body>
</html>
