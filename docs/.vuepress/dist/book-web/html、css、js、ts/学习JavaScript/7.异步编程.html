<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7.异步编程 | Liawn&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <meta charset="UTF-8">
  <link rel="icon" href="/blog-vuepress/favicon.ico">
    <meta name="description" content="用vuepress搭建的个人博客">
    <meta charset="UTF-8">
    
    <link rel="preload" href="/blog-vuepress/assets/css/0.styles.5c52d671.css" as="style"><link rel="preload" href="/blog-vuepress/assets/js/app.0d2e1fde.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/2.a046c74e.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/48.c17f8a84.js" as="script"><link rel="prefetch" href="/blog-vuepress/assets/js/10.88d5532b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/100.a282e1e5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/101.1917817b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/102.426bef2e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/103.24a96e53.js"><link rel="prefetch" href="/blog-vuepress/assets/js/104.0b4b8196.js"><link rel="prefetch" href="/blog-vuepress/assets/js/105.98db5522.js"><link rel="prefetch" href="/blog-vuepress/assets/js/106.7a39c799.js"><link rel="prefetch" href="/blog-vuepress/assets/js/11.78e26b31.js"><link rel="prefetch" href="/blog-vuepress/assets/js/12.e39a10a3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/13.da0e53c1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/14.91a6c713.js"><link rel="prefetch" href="/blog-vuepress/assets/js/15.b9f3c2f3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/16.01c98a8e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/17.e733ec41.js"><link rel="prefetch" href="/blog-vuepress/assets/js/18.f4fea388.js"><link rel="prefetch" href="/blog-vuepress/assets/js/19.1d376bae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/20.4751d85a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/21.00437d3b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/22.64839502.js"><link rel="prefetch" href="/blog-vuepress/assets/js/23.7a4335d7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/24.3ee2b263.js"><link rel="prefetch" href="/blog-vuepress/assets/js/25.0767dbc8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/26.c416d882.js"><link rel="prefetch" href="/blog-vuepress/assets/js/27.5e82d924.js"><link rel="prefetch" href="/blog-vuepress/assets/js/28.24de79c4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/29.5a1e4f8e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/3.0b0dd8a7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/30.3c71597f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/31.f5f5fe9d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/32.eac572f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/33.660b2af0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/34.b6f9bd89.js"><link rel="prefetch" href="/blog-vuepress/assets/js/35.2e5e8650.js"><link rel="prefetch" href="/blog-vuepress/assets/js/36.04d6e910.js"><link rel="prefetch" href="/blog-vuepress/assets/js/37.4ffc07ec.js"><link rel="prefetch" href="/blog-vuepress/assets/js/38.f31deb49.js"><link rel="prefetch" href="/blog-vuepress/assets/js/39.5bd11cdb.js"><link rel="prefetch" href="/blog-vuepress/assets/js/4.6edbb2a1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/40.c0dc0955.js"><link rel="prefetch" href="/blog-vuepress/assets/js/41.32840955.js"><link rel="prefetch" href="/blog-vuepress/assets/js/42.afdf16b6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/43.04bbcb6b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/44.3f372036.js"><link rel="prefetch" href="/blog-vuepress/assets/js/45.199528f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/46.c23ffbe2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/47.33bc80d6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/49.9f6c2490.js"><link rel="prefetch" href="/blog-vuepress/assets/js/5.c6c641ea.js"><link rel="prefetch" href="/blog-vuepress/assets/js/50.d6762688.js"><link rel="prefetch" href="/blog-vuepress/assets/js/51.1b65f46c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/52.d00b4d17.js"><link rel="prefetch" href="/blog-vuepress/assets/js/53.becdeb67.js"><link rel="prefetch" href="/blog-vuepress/assets/js/54.fe84cbfc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/55.42ca78e9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/56.38dc1cb5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/57.f4964e37.js"><link rel="prefetch" href="/blog-vuepress/assets/js/58.9b4d0044.js"><link rel="prefetch" href="/blog-vuepress/assets/js/59.cfb9c546.js"><link rel="prefetch" href="/blog-vuepress/assets/js/6.c6de6921.js"><link rel="prefetch" href="/blog-vuepress/assets/js/60.4f4f3658.js"><link rel="prefetch" href="/blog-vuepress/assets/js/61.e691fcda.js"><link rel="prefetch" href="/blog-vuepress/assets/js/62.fd6c77be.js"><link rel="prefetch" href="/blog-vuepress/assets/js/63.9acec8fc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/64.c6c33b9e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/65.30e05c43.js"><link rel="prefetch" href="/blog-vuepress/assets/js/66.fdb85611.js"><link rel="prefetch" href="/blog-vuepress/assets/js/67.4a8c9b0e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/68.cf4c210b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/69.b27adaff.js"><link rel="prefetch" href="/blog-vuepress/assets/js/7.4196f4e6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/70.a3316969.js"><link rel="prefetch" href="/blog-vuepress/assets/js/71.9eb46133.js"><link rel="prefetch" href="/blog-vuepress/assets/js/72.0fe4fe9a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/73.0bf36b4a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/74.fc2e628a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/75.205b56bf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/76.8c2bf9b9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/77.a0993252.js"><link rel="prefetch" href="/blog-vuepress/assets/js/78.41709f17.js"><link rel="prefetch" href="/blog-vuepress/assets/js/79.c8733b25.js"><link rel="prefetch" href="/blog-vuepress/assets/js/8.f87272cd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/80.f5ed5113.js"><link rel="prefetch" href="/blog-vuepress/assets/js/81.ddb61980.js"><link rel="prefetch" href="/blog-vuepress/assets/js/82.1d3482a9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/83.a28d44e2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/84.ce75ed5e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/85.d4ffd27c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/86.14ffaf35.js"><link rel="prefetch" href="/blog-vuepress/assets/js/87.482be605.js"><link rel="prefetch" href="/blog-vuepress/assets/js/88.c1035bd5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/89.e739598f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/9.0f96b506.js"><link rel="prefetch" href="/blog-vuepress/assets/js/90.5a928d71.js"><link rel="prefetch" href="/blog-vuepress/assets/js/91.82d05736.js"><link rel="prefetch" href="/blog-vuepress/assets/js/92.8c0f11ee.js"><link rel="prefetch" href="/blog-vuepress/assets/js/93.5cff49c0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/94.8ad61574.js"><link rel="prefetch" href="/blog-vuepress/assets/js/95.f849a0b0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/96.31401883.js"><link rel="prefetch" href="/blog-vuepress/assets/js/97.98310d37.js"><link rel="prefetch" href="/blog-vuepress/assets/js/98.f626e78b.js"><link rel="prefetch" href="/blog-vuepress/assets/js/99.6891a17b.js">
    <link rel="stylesheet" href="/blog-vuepress/assets/css/0.styles.5c52d671.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><a href="/blog-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Liawn's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav></div></header> <div class="sidebar-wrapper sidebar-hidden"><aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><!----> <span>web前端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/" class="sidebar-heading clickable open"><span class="arrow down"></span> <span>学习JavaScript</span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/1.基础语法.html" class="sidebar-link">1.基础语法</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/2.变量、作用域和内存问题.html" class="sidebar-link">2.变量、作用域和内存问题</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/3.引用类型.html" class="sidebar-link">3.引用类型</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/4.面向对象程序设计.html" class="sidebar-link">4.面向对象程序设计</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/5.函数表达式.html" class="sidebar-link">5.函数表达式</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/6.Http、Ajax和跨域.html" class="sidebar-link">6.Http、Ajax和跨域</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html" class="active sidebar-link">7.异步编程</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/js零碎知识和案例.html" class="sidebar-link">js部分</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习CSS/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习CSS</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习TypeScript/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习TypeScript</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习Vue/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习Vue</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习React/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习React</span></a> <!----></section></li><li><a href="/blog-vuepress/book-web/web前端js框架/学习jQuery.html" class="sidebar-link">jQueryNote</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/LayaBox游戏引擎/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>H5游戏引擎Laya</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>数据结构与算法</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/数据结构与算法/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>数据结构与算法ts版</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>常用工具</span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/常用工具/Npm的使用.html" class="sidebar-link">Npm的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Git的使用.html" class="sidebar-link">Git的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/webpack的使用.html" class="sidebar-link">webpack的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/VSCode的使用.html" class="sidebar-link">VSCode的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Chrome的使用.html" class="sidebar-link">Chrome的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用docsify写blog.html" class="sidebar-link">使用docsify写blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用gitbook写blog.html" class="sidebar-link">使用gitbook写blog</a></li><li><a href="/blog-vuepress/book-web/web前端测试与调试/基于mocha+chai的单元测试.html" class="sidebar-link">使用mocha+chai进行单元测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>简单项目实践</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/项目/react+express+ts写爬虫/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>react+express+ts写爬虫</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>面试准备</span></p> <!----></section></li></ul> </aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div> <main class="page sidebar-hidden right-sidebar-hidden"> <div class="theme-default-content content__default"><h1 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h1> <h2 id="eventloop"><a href="#eventloop" class="header-anchor">#</a> EventLoop</h2> <blockquote><p>参考资料1：<a href="https://html.spec.whatwg.org/multipage/webappapis.html#definitions-3" target="_blank" rel="noopener noreferrer">8 Web application APIs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
参考资料2：<a href="https://blog.csdn.net/qq_34436866/article/details/106941350" target="_blank" rel="noopener noreferrer">跟着whatwg看一遍事件循环<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
参考资料3：<a href="https://zhuanlan.zhihu.com/p/24460769" target="_blank" rel="noopener noreferrer">HTML系列：macrotask和microtask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>js引擎是<strong>单线程</strong>运行的，同一时刻只能执行一个代码块。比如请求接口时，如果js引擎停下来等服务端传来响应，那就会阻塞其他代码运行。所以js引擎处理接口是<strong>异步</strong>的，会将接口响应任务存<strong>消息队列</strong>里然后就执行其他代码了，等后面<strong>执行栈空闲了</strong>再来处理响应任务。类似的还有定时器、侦听器等，它们可以说是<strong>异步请求同步执行</strong>，意思是请求我发给你了，但我得处理其他主要事情（异步请求）；就算你响应立马给我了，我也只是暂时排在任务列表里，手头里主要事情做完了才会去处理响应（同步处理）。</p> <p>js引擎对这些异步操作就是使用<strong>EventLoop事件循环</strong>来调配处理的，所用的消息队列分为<strong>task队列</strong>和<strong>microtask队列</strong>。EventLoop的一个处理回合：首先会先执行<strong>task队列</strong>中的一个任务，然后再执行<strong>microtask队列</strong>里的<strong>所有</strong>任务，最后再根据需要与否去<strong>渲染页面</strong>。在这个回合中是同步执行的，不会出现既要处理这个任务也要处理那个任务。</p> <p>EventLoop中<strong>task队列</strong>可能有多个，原因是其中一个task队列负责优先级比较高的任务（鼠标键盘事件等），另一个task队列负责普通的任务（定时器等）；还有<strong>task队列</strong>是<code>Set</code>而不是<code>Queue</code>，EventLoop会从中取<strong>最早并且可执行</strong>的任务出来并推入执行栈中执行。比较常见的task：<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>、<code>requestAnimationFrame</code>、<code>I/O</code>，还有类似<code>click</code>、<code>ajax</code>还有<code>&lt;script&gt;</code>标签里的代码。</p> <p>EventLoop中<strong>microtask队列</strong>一般只有一个，并且是<code>Queue</code>，找元素用的是<strong>出队列</strong>的方式。比较常见的microtask：<code>Promise</code>、<code>Object.observe</code>、<code>MutationObserver</code>。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>上面这段程序在谷歌浏览器中执行的，其打印顺序就是：<code>2 4 5 3 7 9 10 8 1 6</code>。</p> <ul><li>首先两个<code>&lt;script&gt;</code>标签里代码的运行是两个task，先添加进task队列里；</li> <li>从task队列里取可执行的task，也就是第一个<code>&lt;script&gt;</code>标签开始执行；</li> <li>遇到<code>setTimeout</code>，将它放入task队列里；</li> <li>因为Promise内部是同步的，所以先打印<strong>2和4</strong>，在<code>resolve()</code>后会把Promise的then回调函数放入microtask队列里；</li> <li>遇到<code>console.log(5)</code>，打印完<strong>5</strong>才表示一个task执行完了，现在得去执行microtask队列<strong>所有</strong>任务；
<ul><li>microtask队列目前就一个then回调函数，那么打印<strong>3</strong>，结束microtask队列，进入新的task。</li></ul></li> <li>从task队列里取可执行的task，也就是第二个<code>&lt;script&gt;</code>标签开始执行；</li> <li>遇到<code>setTimeout</code>，将它放入task队列里；</li> <li>因为Promise内部是同步的，所以先打印<strong>7和9</strong>，在<code>resolve()</code>后会把Promise的then回调函数放入microtask队列里；</li> <li>遇到<code>console.log(10)</code>，打印完<strong>10</strong>才表示一个task执行完了，现在得去执行microtask队列<strong>所有</strong>任务；
<ul><li>microtask队列目前就一个then回调函数，那么打印<strong>8</strong>，结束microtask队列，进入新的task。</li></ul></li> <li>从task队列里取可执行的task，也就第一个<code>setTimeout</code>，打印<strong>1</strong>；</li> <li>从task队列里取可执行的task，也就第二个<code>setTimeout</code>，打印<strong>6</strong>；</li> <li>结束了，以上省略了UI渲染，因为没有涉及到页面的操作。</li></ul> <p>上面这些都是说浏览器的EventLoop，其实node环境中还是不一样的，<strong>node.js</strong>有用到<code>process.nextTick</code>，它并不是EventLoop中的一部分，它是优先于<strong>microtask</strong>执行的；还有一个<code>setImmediate</code>，是个定时器，在I/O操作中先于任何其他定时器的，但非I/O操作里<code>setImmediate</code>的先后就不一定了，比较受线程性能的影响（比如设置毫秒数是0到几十的时候，setTimeout一般优于setImmediate）。有兴趣可以查看<a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#what-is-the-event-loop" target="_blank" rel="noopener noreferrer">Node.js 事件循环<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>上面这段程序在<strong>node</strong>中执行的，其打印顺序就是：<code>11 13 5 7 8 10 14 16 9 15 12 6 2 4 1 3</code>。具体不展开了，有时间再来扩展node中EventLoop。</p> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <p>上一节后，我们对异步操作的背后有了比较清晰的认知，但这都是浏览器内部的处理，我们书写<strong>互相依赖</strong>的异步操作的时候，就非常容易形成“回调地狱”，所以后面es6提出了使用<strong>Promise</strong>来解决这种问题。</p> <h3 id="什么是promise"><a href="#什么是promise" class="header-anchor">#</a> 什么是Promise</h3> <p><strong>Promise</strong>内存储着一个异步操作，这个异步操作要等到未来才会有结果。Promise存储的异步操作有三种状态：<strong>pending（进行中）</strong>、<strong>fulfilled（已兑现）<strong>和</strong>rejected（已拒绝）</strong>，这三种状态就是异步操作的结果赋予的，其他人改变不了。</p> <p>还有一个经常跟Promise一起使用的术语：<strong>resolved（已决议）</strong>。它表示异步操作<strong>敲定好了状态</strong>，该状态可能是fulfilled也可能是rejected。</p> <h3 id="调用处使用promise"><a href="#调用处使用promise" class="header-anchor">#</a> 调用处使用Promise</h3> <p>未推出Promise时，一般做法就是回调函数会作为异步函数的<strong>入参</strong>，异步函数里的异步操作结束后会根据结果来执行对应的入参（执行回调函数）。推出Promise后，不会将回调函数传给异步函数，而是异步函数会<strong>返回Promise对象</strong>，异步操作结束后会根据结果来调用Promise对象的<code>then</code>中对应的回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 以前的调用：将sucFun和failFun以参数的形式传给异步函数doA，根据需要会执行sucFun和failFun</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> sucFun<span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用Promise：异步函数doA会返回一个promise对象，根据需要会执行promise对象的then方法里的sucFun和failFun</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sucFun<span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>.then(onFulfilled[, onRejected])</code>中第一个参数是成功回调函数，第二个参数是失败回调函数（可选参数），并且then会返回了一个Promise对象，那就可以继续使用then，这样就会形成一种链式调用。以前接口互相依赖时采用嵌套写法，写起来非常占位置也不美观，现在使用Promise会非常清爽。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 以前，函数嵌套</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回doB的Promise对象，好让后面继续使用链式结构</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注意：onFulfilled或onRejected执行完后，then是返回的一个<strong>新promise</strong>。也就是说你在onFulfilled或onRejected里自己返回一个值或者Error时，也是返回一个promise，可以继续在后面写then这种链式调用。</p> <h3 id="promise对象内部"><a href="#promise对象内部" class="header-anchor">#</a> Promise对象内部</h3> <p>上一节是说怎么使用Promise的方式<strong>调用异步函数</strong>，并且展示了多个异步函数时使用Promise方式的<strong>优势</strong>。这一节说的是异步函数内部会<strong>返回</strong>一个<strong>Promise对象</strong>，这个过程会是一个什么样子呢？</p> <p>首先在异步函数里创建一个Promise对象，<code>new Promise((resolve, reject) =&gt; {})</code>；Promise构造函数会传递一个参数，这个参数是一个<strong>executor处理器函数</strong>，是专门用于处理具体的异步操作的；操作完异步操作当然还要通知调用方，executor函数的两个入参<strong>resolve</strong>和<strong>reject</strong>就是专门做这些事的；当异步任务顺利完成且返回结果值时，会执行<strong>resolve</strong>方法，将Promise对象的状态置为<code>fulfilled</code>；而当异步任务失败且返回失败原因，会执行<strong>resolve</strong>方法，将Promise对象的状态置为<code>rejected</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Promise对象内部（当前小节的内容）</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 这个匿名函数其实是executor函数</span>
        <span class="token comment">/* 某某异步操作 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 操作成功 */</span><span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知操作成功，data是异步操作的结果</span>
        <span class="token keyword">else</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知操作失败，error是一个异常对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用处使用Promise（上一小节的内容）</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接收resolve通知</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接收reject通知</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>一个使用Promise封装ajax的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'get'</span> <span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> statusText</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="关于错误处理"><a href="#关于错误处理" class="header-anchor">#</a> 关于错误处理</h3> <p><strong>错误处理</strong>：遇到异常抛出时，会顺着Promise链寻找下一个<strong>onRejected</strong>失败回调函数（then中的onRejected），如果没有一个onRejected，就会去<code>.catch()</code>里指定的函数里执行。可以看<a href="#%E8%B0%83%E7%94%A8%E5%A4%84%E4%BD%BF%E7%94%A8promise">调用处使用promise</a>的第二个例子，其中有三次failFun，但最后只用<code>.catch()</code>来处理。</p> <p>可以对错误进行精准的捕获，只是需要<strong>嵌套Promise</strong>。下面这个例子中内部嵌套了一个Promise，并且还带了一个catch，这个catch能精准捕获到doB和doC的失败，而doA只会被最外层的catch会捕获。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token parameter">rlt</span> <span class="token operator">=&gt;</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">optRlt</span> <span class="token operator">=&gt;</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span> <span class="token operator">=&gt;</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="时序和拒绝事件"><a href="#时序和拒绝事件" class="header-anchor">#</a> 时序和拒绝事件</h3> <p>已经变成resolve状态的Promise对象，会通知then()里对应的函数，这个通知传递的过程是异步的。也就是说传递到then()中的回调函数是会被放到一个microtask队列里的，不过Promise对象里其他的执行还是同步，这就能印证<a href="#eventloop">EventLoop</a>里第一个例子中<code>2</code>和<code>4</code>为什么先于<code>3</code>打印。</p> <p><strong>拒绝事件</strong>：当Promise被拒绝时，如果有reject函数处理了，就会派发rejectionhandled事件到全局作用域；如果没有经过reject函数处理，则会派发unhandledrejection事件到全局作用域。两个事件都有<strong>promise</strong>属性和<strong>reason</strong>属性，其中promise属性是指向被驳回的promise，reason属性是说明被驳回的原因。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">/* 你可以在这里添加一些代码，以便检查
     event.promise 中的 promise 和
     event.reason 中的 rejection 原因 */</span>
  event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="promise组合工具"><a href="#promise组合工具" class="header-anchor">#</a> Promise组合工具</h3> <p><strong>Promise.resolve(value)</strong>：手动创建一个已经resolve的Promise对象，相当于<code>new Promise(resolve =&gt; resolve(value))</code>（但不完全是，因为下一节会讲<code>new Promise(r =&gt; r(v))</code>中<code>v</code>是个Promise对象的情况）。</p> <p><strong>Promise.reject(value)</strong>：手动创建一个已经reject的Promise对象，相当于<code>new Promise((resolve, reject) =&gt; reject(value))</code>。</p> <p><strong>var p = Promise.all([p1, p2, p3])</strong>：all接受一个Promise对象数组（也可以是Iterator并且返回Promise对象），当数组里所有的Promise对象状态为fulfilled时，p这个Promise对象状态才为fulfilled，并且结果也会组成数组传递给p的回调函数；当数组里只要一个被rejected了，那么p就是rejected状态，其结果会传递给p的回调函数。</p> <p><strong>var p = Promise.race([p1, p2, p3])</strong>：race接受一个Promise对象数组（也可以是Iterator并且返回Promise对象），当数组里只要一个被确定状态了，那么p就是随之确定状态了，其结果会传递给p的回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 1.并行操作</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">,</span> result3<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.归并，从Promise.resolve()开始执行func1再执行func2再执行func3，最后到result3</span>
<span class="token punctuation">[</span>func1<span class="token punctuation">,</span> func2<span class="token punctuation">,</span> func3<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result3</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">/* use result3 */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.跟上面2是一样的，直接后面追加加，上面肯定要灵活一些</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 4.其实就是用函数封装了2</span>
<span class="token keyword">const</span> <span class="token function-variable function">composeAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">x</span> <span class="token operator">=&gt;</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>applyAsync<span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 5.其实就是用函数封装了3</span>
<span class="token keyword">const</span> <span class="token function-variable function">applyAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span>val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> acc<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="resolve一个promise对象"><a href="#resolve一个promise对象" class="header-anchor">#</a> resolve一个Promise对象</h3> <p>你可能会遇到这样的问题：<code>Promise.resolve(Promise.resolve(1))</code>、<code>Promise.resolve(new Promise(r =&gt; r(1)))</code>、<code>new Promise(r =&gt; r(Promise.resolve(1)))</code>、<code>new Promise(r =&gt; r(new Promise(nr =&gt; nr(1))))</code>，这四个有什么区别？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">nr</span> <span class="token operator">=&gt;</span> <span class="token function">nr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在控制台里打印上面的代码，会有如下结果：</p> <p><img src="data:image/png;base64,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" alt="resolve-promise"></p> <p>其实就是问<code>Promise.resolve(v)</code>和<code>new Promise(r =&gt; r(v))</code>的区别。</p> <ul><li><code>Promise.resolve(v)</code>：如果<code>v</code>是普通值，会将这个普通值包装成已经<code>fulfilled</code>的Promise实例；如果<code>v</code>本就是一个Promise实例，那就会原封不动返回<code>v</code>。</li> <li><code>new Promise(r =&gt; r(v))</code>：如果<code>v</code>是普通值，那整体会是一个已经<code>fulfilled</code>的Promise实例；但是如果<code>v</code>本就是一个Promise实例，那底层会调用<code>ResolvePromise(promise, resolution)</code>去<strong>处理</strong>，其中入参<code>promise</code>是<code>new Promise(r =&gt; r(xxx))</code>本身，入参<code>resolution</code>是<code>v</code>。具体的：
<ul><li>处理时会创建PromiseResolveThenableJob，创建的PromiseResolveThenableJob会作为一个microtask；</li> <li>然后会运行PromiseResolveThenableJob让<code>v</code>的then里的回调函数进入microtask队列，也就是占了一个microtask；</li> <li>运行完后，<code>new Promise(r =&gt; r(xxx))</code>本身状态会变为<code>fulfilled</code>，那么总的来说<code>new Promise(r =&gt; r(v)</code>整体变为<code>fulfilled</code>会<strong>占用两个microtask时序</strong>。</li></ul></li></ul> <p>另外一个知识点，<code>then()</code>对外暴露应该是一个Promise对象，如果在then内部<code>return v;</code>，这个<code>return v;</code>要分两种情况，其实和上面的<code>new Promise(r =&gt; r(v))</code>是一样的。</p> <ul><li>如果<code>return v;</code>语句的值是一个是普通值，那then对外暴露的Promise对象其实就是将这个普通值<code>v</code>包装成已经<code>fulfilled</code>的Promise对象。</li> <li>如果<code>return v;</code>语句的值本就是一个Promise对象，那么底层会调用<code>ResolvePromise(promise, resolution)</code>处理，入参<code>promise</code>就是then对外暴露的Promise对象，resolution就是<code>v</code>这个Promise对象。会经过PromiseResolveThenableJob的创建和运行（占用两个microtask时序），最后让then对外暴露的Promise对象的状态变为<code>fulfilled</code>。</li></ul> <p>为什么不直接让<code>v</code>赋给目标Promise对象，这样就太简单粗暴了，<code>v</code>的状态是<code>pending</code>还是<code>fulfilled</code>是不确定（即使是<code>fulfilled</code>，但它的then回调函数还没执行）。得使用PromiseResolveThenableJob来确定<code>v</code>的状态并执行它的then回调函数，这些走完后才能让目标Promise也<code>fulfilled</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 then 2 3 4</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 原封不动返回p，所以相当于p.then(v =&gt; console.log(v))，那么&quot;then&quot;会比2先打印</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 2 3 then 4</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// resolve(p)，创建PromiseResolveThenableJob会占用一个microtask</span>
<span class="token comment">// 运行PromiseResolveThenableJob，让p的then回调函数执行，这也会占用一个microtask</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 经过两个时序（打印了2和3）才打印了&quot;then&quot;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 test 2 3 4 then</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise.resolve(p).then相当于p.then，那么&quot;test&quot;会先于2，这个同第一个例子</span>
<span class="token comment">// 第一个then里是return Promise.resolve(v)，这会触发ResolvePromise(promise, resolution)，</span>
<span class="token comment">// promise入参是代表第一个then的promise，resolution入参是v。跟上一个例子一样要占用两个micrtask时序</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token comment">// 其实如果是return v;那就不会触发ResolvePromise了</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 但是比上一例子多了一个then，那么&quot;then&quot;会在4后面打印了</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div> <p>参考资料：</p> <ul><li><a href="https://chromium.googlesource.com/v8/v8.git/+/refs/heads/9.0-lkgr/src/builtins/promise-resolve.tq#88" target="_blank" rel="noopener noreferrer">关于ResolvePromise<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>至于PromiseResolveThenableJob为什么会消耗两个micrtask可以看<a href="https://www.zhihu.com/question/430549238/answer/1624864911" target="_blank" rel="noopener noreferrer">resolve(resolvedPromise)情况源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章。</li></ul> <h2 id="async和await"><a href="#async和await" class="header-anchor">#</a> async和await</h2> <h3 id="简单使用async和await"><a href="#简单使用async和await" class="header-anchor">#</a> 简单使用async和await</h3> <p><strong>async</strong>和<strong>await</strong>的搭配使用，可以写出更简洁的基于Promise的异步行为。async用来修饰函数表示函数中即将使用await表达式，async函数一定会返回一个promise对象（就算没有也会被Promise.resolve转换）；await用于暂停整个async函数的执行进程并出让其控制权，只有当其等待的基于promise的异步操作被兑现或被拒绝之后才会恢复进程；其实await可以用于普通函数，也就是await等到的是一个普通值，它就是不会让出控制权（不阻塞后面的代码）。基本语法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>param<span class="token punctuation">[</span><span class="token punctuation">,</span> param<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span> param<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statements <span class="token comment">// 0个或者多个await表达式</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们来使用<strong>async</strong>和<strong>await</strong>重写之前Promise的例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回doB的Promise对象，好让后面继续使用链式结构</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用async和await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> rlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> newRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> finRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>改写精准的错误捕获例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">rlt</span> <span class="token operator">=&gt;</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">optRlt</span> <span class="token operator">=&gt;</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span> <span class="token operator">=&gt;</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用async和await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> rlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> optRlt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> newRlt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            optRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            newRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> finRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'FinalResult:'</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="async和await相关执行顺序"><a href="#async和await相关执行顺序" class="header-anchor">#</a> async和await相关执行顺序</h3> <p>我们先看一下EventLoop、Promise、async/await等结合起来的题目：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// await &quot;2&quot;，会转换为await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
    <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
    <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
    <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 7 2 3 4</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// testSometing()里用了async标识，并且返回是`return Promise.resolve(&quot;2&quot;)`</span>
    <span class="token comment">// 这会导致要经过ResolvePromise(promise, resolution)的处理，入参promise是</span>
    <span class="token comment">// testSometing()对外暴露的Promise对象，入参resolution是Promise.resolve(&quot;2&quot;)</span>
    <span class="token comment">// 处理完后`await testSometing()`这里才`fulfilled`，那么`7`会先于`2`打印</span>
    <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div> <p>要解释上面这些例子必须先弄懂<strong>不带</strong>async/await的异步执行顺序问题，也就是<a href="#resolve%E4%B8%80%E4%B8%AApromise%E5%AF%B9%E8%B1%A1">resolve一个Promise对象</a>的内容。</p> <p>然后还要知道async函数的对外暴露的得是一个Promise对象，如果在sync函数内部<code>return v;</code>，它的处理和<code>then()</code>一样：</p> <ul><li>如果<code>return v;</code>语句的值是一个是普通值，那async函数的对外暴露的Promise对象其实就是将这个普通值<code>v</code>包装成已经<code>fulfilled</code>的Promise对象。</li> <li>如果<code>return v;</code>语句的值本就是一个Promise对象，那么底层会调用<code>ResolvePromise(promise, resolution)</code>处理，入参<code>promise</code>就是async函数的对外暴露的Promise对象，入参<code>resolution</code>就是<code>v</code>这个Promise对象。会经过PromiseResolveThenableJob的创建和运行（占用两个microtask时序），最后让async函数的对外暴露的Promise对象的状态变为<code>fulfilled</code>。</li></ul> <p>最后还要知道await等到的值是普通值是会被<code>Promise.resolve()</code>进行隐式转换（转换后是<code>fulfilled</code>的）。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/6/2022, 3:41:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/6.Http、Ajax和跨域.html" class="prev">
        6.Http、Ajax和跨域
      </a></span> <span class="next"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/js零碎知识和案例.html">
        js部分
      </a>
      →
    </span></p></div> </main> <div class="right-sidebar-wrapper right-sidebar-hidden"><aside class="right-sidebar"><ul><h4>本文目录</h4></ul></aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div></div><div class="global-ui"></div></div>
    <script src="/blog-vuepress/assets/js/app.0d2e1fde.js" defer></script><script src="/blog-vuepress/assets/js/2.a046c74e.js" defer></script><script src="/blog-vuepress/assets/js/48.c17f8a84.js" defer></script>
  </body>
</html>
