<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7.性能优化 | Liawn&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <meta charset="UTF-8">
  <link rel="icon" href="/blog-vuepress/favicon.ico">
  <link rel="manifest" href="/blog-vuepress/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/blog-vuepress/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/blog-vuepress/safari-pinned-tab.svg" color="#ffffff">
  <meta name="msapplication-TileImage" content="/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    <meta name="description" content="用vuepress搭建的个人博客">
    <meta charset="UTF-8">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog-vuepress/assets/css/0.styles.2f620dda.css" as="style"><link rel="preload" href="/blog-vuepress/assets/js/app.34680ebc.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/2.1e7adb41.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/42.7f4e1373.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/38.cec9a03e.js" as="script"><link rel="prefetch" href="/blog-vuepress/assets/js/10.1e723314.js"><link rel="prefetch" href="/blog-vuepress/assets/js/100.311567ba.js"><link rel="prefetch" href="/blog-vuepress/assets/js/101.ef72e26e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/102.c3759919.js"><link rel="prefetch" href="/blog-vuepress/assets/js/103.98e877a9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/104.e27de6a0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/105.3a1ef548.js"><link rel="prefetch" href="/blog-vuepress/assets/js/106.59ee0f92.js"><link rel="prefetch" href="/blog-vuepress/assets/js/107.e68abe87.js"><link rel="prefetch" href="/blog-vuepress/assets/js/108.8fcda232.js"><link rel="prefetch" href="/blog-vuepress/assets/js/109.422d008d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/11.58bde1dd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/110.f713fc26.js"><link rel="prefetch" href="/blog-vuepress/assets/js/111.58efaae4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/112.c6bdfbe0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/113.8dbd693e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/114.8a85e37a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/115.54a6972e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/116.56b2d8b8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/117.11470546.js"><link rel="prefetch" href="/blog-vuepress/assets/js/118.1a39e213.js"><link rel="prefetch" href="/blog-vuepress/assets/js/119.41f15fbd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/12.613505ee.js"><link rel="prefetch" href="/blog-vuepress/assets/js/120.9ac14643.js"><link rel="prefetch" href="/blog-vuepress/assets/js/121.83954220.js"><link rel="prefetch" href="/blog-vuepress/assets/js/122.bef8fade.js"><link rel="prefetch" href="/blog-vuepress/assets/js/123.25446ff9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/124.6acf9e60.js"><link rel="prefetch" href="/blog-vuepress/assets/js/125.42c6fb5e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/126.b9b98daa.js"><link rel="prefetch" href="/blog-vuepress/assets/js/127.382eea79.js"><link rel="prefetch" href="/blog-vuepress/assets/js/13.75740994.js"><link rel="prefetch" href="/blog-vuepress/assets/js/14.febc6ec1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/15.6e16849c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/16.70db9d99.js"><link rel="prefetch" href="/blog-vuepress/assets/js/17.f098e403.js"><link rel="prefetch" href="/blog-vuepress/assets/js/18.21ad25ae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/19.4b561714.js"><link rel="prefetch" href="/blog-vuepress/assets/js/20.8dae8a78.js"><link rel="prefetch" href="/blog-vuepress/assets/js/21.7d09e2a3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/22.7838f809.js"><link rel="prefetch" href="/blog-vuepress/assets/js/23.2444198c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/24.099866db.js"><link rel="prefetch" href="/blog-vuepress/assets/js/25.d059d716.js"><link rel="prefetch" href="/blog-vuepress/assets/js/26.243af3f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/27.97e455c9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/28.97ce9b54.js"><link rel="prefetch" href="/blog-vuepress/assets/js/29.392d550e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/3.49db6791.js"><link rel="prefetch" href="/blog-vuepress/assets/js/30.9161535d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/31.46b99656.js"><link rel="prefetch" href="/blog-vuepress/assets/js/32.c2fd0854.js"><link rel="prefetch" href="/blog-vuepress/assets/js/33.3080b8a5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/34.e15baec0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/35.f144a7bd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/36.e1175535.js"><link rel="prefetch" href="/blog-vuepress/assets/js/37.72ec58bc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/39.fc6f4606.js"><link rel="prefetch" href="/blog-vuepress/assets/js/4.eca03551.js"><link rel="prefetch" href="/blog-vuepress/assets/js/40.b74ded47.js"><link rel="prefetch" href="/blog-vuepress/assets/js/41.cee8cec1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/43.10c6d899.js"><link rel="prefetch" href="/blog-vuepress/assets/js/44.4f190d43.js"><link rel="prefetch" href="/blog-vuepress/assets/js/45.5c2f36ae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/46.9a5337f5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/47.161b10c1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/48.93192e20.js"><link rel="prefetch" href="/blog-vuepress/assets/js/49.72ba1cc4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/5.aacc9c46.js"><link rel="prefetch" href="/blog-vuepress/assets/js/50.bfc0c26a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/51.05bbb696.js"><link rel="prefetch" href="/blog-vuepress/assets/js/52.84b5a67c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/53.220715ca.js"><link rel="prefetch" href="/blog-vuepress/assets/js/54.d433d73f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/55.f8221d0f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/56.2ec79246.js"><link rel="prefetch" href="/blog-vuepress/assets/js/57.01a3b85e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/58.9015a667.js"><link rel="prefetch" href="/blog-vuepress/assets/js/59.73311086.js"><link rel="prefetch" href="/blog-vuepress/assets/js/6.0c335663.js"><link rel="prefetch" href="/blog-vuepress/assets/js/60.976cf8cc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/61.4a1c95f1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/62.865f814a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/63.0d882dec.js"><link rel="prefetch" href="/blog-vuepress/assets/js/64.c74f770a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/65.0d5262a8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/66.1cd8fc00.js"><link rel="prefetch" href="/blog-vuepress/assets/js/67.a73db0e8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/68.2fe7b184.js"><link rel="prefetch" href="/blog-vuepress/assets/js/69.763746bf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/7.09a81cb8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/70.2f10d153.js"><link rel="prefetch" href="/blog-vuepress/assets/js/71.f0476a16.js"><link rel="prefetch" href="/blog-vuepress/assets/js/72.b3aa24c4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/73.d90b4378.js"><link rel="prefetch" href="/blog-vuepress/assets/js/74.5f3afc25.js"><link rel="prefetch" href="/blog-vuepress/assets/js/75.610a9393.js"><link rel="prefetch" href="/blog-vuepress/assets/js/76.397a07d0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/77.a7a16098.js"><link rel="prefetch" href="/blog-vuepress/assets/js/78.0a76e3c0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/79.d9bf3b6d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/8.7a4382cf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/80.6653af85.js"><link rel="prefetch" href="/blog-vuepress/assets/js/81.7bfd7632.js"><link rel="prefetch" href="/blog-vuepress/assets/js/82.e5ec57b6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/83.7728c890.js"><link rel="prefetch" href="/blog-vuepress/assets/js/84.dd67c36e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/85.7387a0e5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/86.bbfe7f7f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/87.2de3f2a7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/88.809122f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/89.321e8e47.js"><link rel="prefetch" href="/blog-vuepress/assets/js/9.26929067.js"><link rel="prefetch" href="/blog-vuepress/assets/js/90.5ce6c826.js"><link rel="prefetch" href="/blog-vuepress/assets/js/91.075154c5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/92.11b94685.js"><link rel="prefetch" href="/blog-vuepress/assets/js/93.a9d4d5f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/94.306ece7e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/95.817525f6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/96.beed2305.js"><link rel="prefetch" href="/blog-vuepress/assets/js/97.b4c539f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/98.8e445314.js"><link rel="prefetch" href="/blog-vuepress/assets/js/99.558669ea.js">
    <link rel="stylesheet" href="/blog-vuepress/assets/css/0.styles.2f620dda.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><a href="/blog-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Liawn's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav></div></header> <div class="sidebar-wrapper sidebar-hidden"><aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><!----> <span>web前端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习JavaScript</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习CSS/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习CSS</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习TypeScript/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习TypeScript</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习Vue/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习Vue</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习React/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习React</span></a> <!----></section></li><li><a href="/blog-vuepress/book-web/web前端js框架/学习jQuery.html" class="sidebar-link">jQueryNote</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/LayaBox游戏引擎/" class="sidebar-heading clickable open"><span class="arrow down"></span> <span>H5游戏引擎Laya</span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/1.环境搭建.html" class="sidebar-link">1.环境搭建</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/2.IDE的使用.html" class="sidebar-link">2.IDE的使用</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/3.组件库的介绍.html" class="sidebar-link">3.组件库的介绍</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/4.常用组件详解.html" class="sidebar-link">4.常用组件详解</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/5.组件化开发.html" class="sidebar-link">5.组件化开发</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/6.屏幕适配与抗锯齿.html" class="sidebar-link">6.屏幕适配与抗锯齿</a></li><li><a href="/blog-vuepress/book-web/LayaBox游戏引擎/7.性能优化.html" class="active sidebar-link">7.性能优化</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>常用工具</span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/常用工具/Npm的使用.html" class="sidebar-link">Npm 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Git的使用.html" class="sidebar-link">Git 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/webpack的使用.html" class="sidebar-link">webpack 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/VSCode的使用.html" class="sidebar-link">VSCode 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Chrome的使用.html" class="sidebar-link">Chrome 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用vuepress写blog.html" class="sidebar-link">使用 vuepress 写 blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用docsify写blog.html" class="sidebar-link">使用 docsify 写 blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用gitbook写blog.html" class="sidebar-link">使用 gitbook 写 blog</a></li><li><a href="/blog-vuepress/book-web/web前端测试与调试/基于mocha+chai的单元测试.html" class="sidebar-link">使用 mocha+chai 进行单元测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>Web后端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web后端/学习node.js/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习node.js</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web后端/学习python/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习python</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>简单项目实践</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/项目/react+express+ts写爬虫/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>react+express+ts写爬虫</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>数据结构与算法</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/数据结构与算法/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>数据结构与算法ts版</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>面试准备</span></p> <!----></section></li></ul> </aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div> <main class="page sidebar-hidden right-sidebar-hidden"> <div class="theme-default-content content__default"><h1 id="性能优化"><a href="#性能优化" class="header-anchor">#</a> 性能优化</h1> <h2 id="性能统计面板"><a href="#性能统计面板" class="header-anchor">#</a> 性能统计面板</h2> <p>Laya 引擎内置有性能统计面板，可实时检测当前性能。在 init()后添加 **Laya.Stat.show(0,0);**代码即可以性能统计面板（参数是位置）。<br> <img src="/blog-vuepress/assets/img/性能面板.761da243.png" alt="性能面板"></p> <ul><li><strong>FPS</strong>：每秒传输帧数(Frames Per Second)，有 FPS(Canvas)和 FPS(WebGL)两种显示，第一个值是 <strong>FPS 帧速</strong>，越高越好，第二个值是 <strong>每帧渲染所消耗的时间（毫秒）</strong>，越小越好；这两个值如果不能维持在满帧，一般是正在操作页面。</li> <li><strong>Sprite</strong>：统计 <strong>所有渲染节点（包括容器）数量</strong>，反映了 <strong>引擎节点遍历、数据组织和渲染的次数</strong> 。数字 <strong>越低越好</strong>，在 UI 设计时尽可能减少不必要的节点以及嵌套。</li> <li><strong>DrawCall</strong>：Canvas 模式下表示 <strong>每帧的绘制次数</strong>，包括图片、文字、矢量图；WebGL 模式下表示 <strong>渲染提交批次</strong>，每次准备数据并通知 GPU 渲染绘制的过程称为 1 次 DrawCall，在每 1 次 DrawCall 中除了在通知 GPU 的渲染上比较耗时之外，切换材质与 shader 也是非常耗时的操作。DrawCall 是 <strong>越少越好</strong>，建议开发者尽量限制在 100 之下。</li> <li><strong>CurMem</strong>：WebGL 模式下表示 <strong>内存与显存的占用</strong>；Canvas 模式下（没显存概念）表示 <strong>内存的占用情况</strong>。值越低越好。</li> <li><strong>Shader</strong>：WebGL 模式独有的性能指标，表示 <strong>每帧 Shader 提交次数</strong>，值越低越好。</li> <li><strong>Canvas</strong>：只有设置<a href="/blog-vuepress/book-web/LayaBox游戏引擎/7.性能优化.html#cacheas静态缓存优化">CacheAs</a>后，Canvas 才会有值，否则默认为 0/0/0。从左至右数值的意义分别为：<strong>每帧重绘的画布数量 / 缓存类型为“normal”类型的画布数量 / 缓存类型为“bitmap”类型的画布数量</strong></li></ul> <h2 id="内存优化"><a href="#内存优化" class="header-anchor">#</a> 内存优化</h2> <h3 id="使用对象池优化"><a href="#使用对象池优化" class="header-anchor">#</a> 使用对象池优化</h3> <p>游戏中某类的对象 <strong>不停创建和移除</strong>，可以使用 <strong>对象池</strong> 让对象复用，这样可以减少 <strong>新内存的分配</strong> 还有 <strong>垃圾回收器运行的机会（垃圾回收时也耗内存）</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 参数1是这类对象的标识符，参数2是类；返回一个对象（没有就新建这一类的对象池，有就从对象池里取）</span>
Laya<span class="token punctuation">.</span>Pool<span class="token punctuation">.</span><span class="token function">getItemByClass</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> Laya<span class="token punctuation">.</span>Image<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 参数1是这类对象的标识符，回收的对象</span>
Laya<span class="token punctuation">.</span>Pool<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> img1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果自己实现一个对象池呢？可以使用 <strong>Map</strong>，key 使用类名，value 就是对象数组。</p> <h3 id="使用-handler-create"><a href="#使用-handler-create" class="header-anchor">#</a> 使用 Handler.create</h3> <p><img src="/blog-vuepress/assets/img/Handler.create.84a0af8f.png" alt="Handler.create"></p> <p>分批加载资源，第一批资源加载完成，触发 Laya.Handler.create()创建的 complete 事件回调方法后 <strong>被对象池回收</strong>；需要加载第二批资源时，Laya.Handler.create()会首先 <strong>在对象池中检索相同的</strong> 回调方法处理器，这样节省了内存开销。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onAssetLoaded<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但是如果要显示加载资源的进度这个时候需要格外注意，可能会这样写（只会显示一次加载进度）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onAssetLoaded<span class="token punctuation">)</span><span class="token punctuation">,</span> Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onLoading<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为要持续显示加载进度，但是 Handler.create <strong>默认执行一次就会收到对象</strong>（只会显示一次加载进度），那么就需要 <strong>关闭</strong> Handler.create 的 <strong>对象池回收</strong>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
  urls<span class="token punctuation">,</span>
  Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onAssetLoaded<span class="token punctuation">)</span><span class="token punctuation">,</span>
  Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onLoading<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或者使用Handler的实例，它的实例里是没有对象回收池</span>
Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> Laya<span class="token punctuation">.</span>Handler<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onAssetLoaded<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Laya<span class="token punctuation">.</span>Handler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onLoading<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="内存释放"><a href="#内存释放" class="header-anchor">#</a> 内存释放</h3> <p>垃圾回收前，要确保对象所有的引用都被删除了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//创建一个Sprite实例</span>
<span class="token keyword">var</span> <span class="token literal-property property">sp</span><span class="token operator">:</span> Laya<span class="token punctuation">.</span>Sprite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Laya<span class="token punctuation">.</span>Sprite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将sp内部引用设置为null</span>
sp<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>js 垃圾回收机制只有在 <strong>内存足够低</strong> 时才运行，或者 <strong>内存分配</strong> 也会触发。</p> <h3 id="资源卸载"><a href="#资源卸载" class="header-anchor">#</a> 资源卸载</h3> <p>游戏会分批加载资源，有些资源就用那么一次后面就不会再用了，那么可以在使用后对其进行 <strong>资源卸载</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token literal-property property">assets</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
assets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;res/apes/monkey0.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
assets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;res/apes/monkey1.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> assets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//查看log，清理前资源一直在内存中</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">getRes</span><span class="token punctuation">(</span>assets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//调用清理方法</span>
  Laya<span class="token punctuation">.</span>loader<span class="token punctuation">.</span><span class="token function">clearRes</span><span class="token punctuation">(</span>assets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="关于滤镜、遮罩"><a href="#关于滤镜、遮罩" class="header-anchor">#</a> 关于滤镜、遮罩</h3> <p>如果不是动态使用滤镜、遮罩等，可以直接使用 <strong>PS</strong> 等工具制作图片的 <strong>滤镜、遮罩效果</strong>；
但是如果要在引擎中 <strong>动态使用滤镜、遮罩，这样很耗性能</strong>，因为它再引擎中会创建两个位图，一个用于原图的栅格化版本，一个用于生成滤镜或遮罩版本，在动态改变时两个位图会重新创建，占用内存也占用 CPU 的计算。</p> <h2 id="渲染优化"><a href="#渲染优化" class="header-anchor">#</a> 渲染优化</h2> <h3 id="优化-sprite"><a href="#优化-sprite" class="header-anchor">#</a> 优化 Sprite</h3> <ol><li>减少不必要的 sprite 和层次嵌套；</li> <li>非可见区域对象尽量移除或设置 visible=false；</li> <li>可以考虑使用 panel，因为 panel 可视区域外的直接子节点不会进行渲染；</li> <li>尽量让 <strong>动态内容和静态内容</strong> 分开，容器内静态内容不会经常变化，可以对容器设置 cacheAs 属性来优化节点数或 DrawCall。</li></ol> <h3 id="优化-drawcall"><a href="#优化-drawcall" class="header-anchor">#</a> 优化 DrawCall</h3> <ol><li>尽量保证同图集的图片渲染顺序是挨着的，如果不同图集交叉渲染，会增加 DrawCall 数量；</li> <li>尽量保证同一个面板中的所有资源用一个图集，这样能减少 DrawCall。</li></ol> <h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <ol><li><p>描边的文本会比没有描边的多调用一次绘图指令，动态的描边文本并且总字符少的可以使用<a href="/blog-vuepress/book-web/LayaBox游戏引擎/4.常用组件详解.html#切片组件">“切片组件”</a>，静态的可以使用 cacheAs 降低性能消耗；</p></li> <li><p>文本始终只有一行，并且样式始终不变的，在内容改变时可以使用 Text.changeText</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">;</span>
Laya<span class="token punctuation">.</span>stage<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//后面只是更新文字内容，使用changeText能提高性能</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token string">&quot;text changed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol> <h2 id="cacheas-静态缓存优化"><a href="#cacheas-静态缓存优化" class="header-anchor">#</a> CacheAs 静态缓存优化</h2> <h3 id="什么是-cacheas"><a href="#什么是-cacheas" class="header-anchor">#</a> 什么是 CacheAs</h3> <p>设置 CacheAs 可以将显示对象 <strong>缓存为静态图像</strong>，当子对象发生变化时会自动重新缓存；<br>
建议把 <strong>不经常变化的复杂内容</strong> 设置 CacheAs，能极大提高渲染性能；<br>
设置 cacheAs 后，还可以设置 staticCache=true 以阻止自动更新缓存，同时可以手动调用 reCache 方法更新缓存。</p> <h3 id="cacheas-的几种缓存模式"><a href="#cacheas-的几种缓存模式" class="header-anchor">#</a> CacheAs 的几种缓存模式</h3> <ul><li><strong>“none”时</strong>，不做任何缓存。</li> <li><strong>“normal”时</strong>，Canvas 下进行画布缓存，webgl 模式下进行命令缓存；该模式性能优化中等，它能减少每帧渲染的节点数，但不会减少 DrawCall 数和 Shader 数。</li> <li><strong>“bitmap”时</strong>，Canvas 下进行依然是画布缓存，webGL 模式下使用 renderTarget 缓存；renderTarget 缓存模式有 2048 大小限制，超出 2048 会额外增加内存开销；另外，不断重绘时开销也比较大，但是会减少 drawcall，渲染性能最高。</li></ul> <h3 id="测试是否频繁重绘"><a href="#测试是否频繁重绘" class="header-anchor">#</a> 测试是否频繁重绘</h3> <p>Laya 提供的 DebugPanel 调试工具可以查看游戏重绘区，使用时在代码里增加 <strong>DebugPanel.init();</strong>。</p> <p><a href="./img/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%A7%82%E5%AF%9FUI%E6%98%AF%E5%90%A6%E9%A2%91%E7%B9%81%E9%87%8D%E7%BB%98.png">观察 UI 是否频繁重绘</a></p> <p>勾选 <strong>“显示当前 cache 重绘”</strong> 选项或 <strong>“显示所有重绘区域”</strong> 选项，如果 UI 进行重绘了，重绘区域会显示出绿色框线，绿色框的左上角显示了重绘次数与重绘时间，性能统计工具的 Sprite、DrawCall 等也会发生改变。</p> <h3 id="如何选择缓存模式"><a href="#如何选择缓存模式" class="header-anchor">#</a> 如何选择缓存模式</h3> <p>CPU 方面：假如开启了 DebugPanel 调试工具，如果 <strong>绿色线框频繁出现，说明 UI 在频繁的重绘</strong>，那么 <strong>最好不要</strong> 用 bitmap 模式，normal 模式 <strong>可以酌情考虑</strong>。因为缓存位图时子对象一旦发生改变，那么引擎会自动重新缓存位图，缓存位图的过程会消耗 CPU。</p> <p>可以把 UI 进行 <strong>分层管理</strong>，频繁更新的为一层（不使用 cacheAs），不频繁更新的为一层（使用 cacheAs），这种方法也能提高性能。</p> <p>内存方面：bitmap 模式会比 normal 模式 <strong>多占用一些内存</strong>，但只要 UI 的宽高不是很大，bitmap 模式多占用的内存 <strong>也不会太大</strong>。</p> <h3 id="低端机型的配置因素"><a href="#低端机型的配置因素" class="header-anchor">#</a> 低端机型的配置因素</h3> <p>对于一些低端机来说，CPU 与内存不高，如果为了提高渲染性能使用了 cacheAs，有可能就会出现问题。如果还是选择适应更多的低端机型，那就需要反复去测试，是否使用 cacheAs，还要对比 normal 与 bitmap 模式哪种更适合，在优化性能的情况下尽量减少 CPU 和内存损耗。</p> <h3 id="什么情况下不能使用-cacheas"><a href="#什么情况下不能使用-cacheas" class="header-anchor">#</a> 什么情况下不能使用 cacheAs</h3> <ol><li>当对象 <strong>非常简单时</strong>，比如一个字或者一个图片，设置 cacheAs 不但不提高性能，反而会损失性能。</li> <li>容器内有经常变化的内容，比如容器内有一个动画或者倒计时，如果再对这个容器设置 cacheAs，会损失性能</li></ol> <p>总的来说就是 cacheAs <strong>适合不经常变化的复杂内容</strong>，如果容器里有部分经常变化另外一部分不经常变化，可以考虑 <strong>分层管理</strong>。</p> <h2 id="减少-cpu-使用量"><a href="#减少-cpu-使用量" class="header-anchor">#</a> 减少 CPU 使用量</h2> <h3 id="减少动态属性查找"><a href="#减少动态属性查找" class="header-anchor">#</a> 减少动态属性查找</h3> <p>在对象的大量属性里查找一个属性会很耗时，如果后面频繁使用这个属性的话会更耗时，那就很有必要使用 <strong>局部变量</strong> 来保存它:</p> <h3 id="计时器"><a href="#计时器" class="header-anchor">#</a> 计时器</h3> <p>Laya.timer.frameLoop 按帧执行，Laya.timer.loop 按时间执行，使用 Laya.timer.clear(this, this.xxx)可以清除其内部的 Timer。</p> <h3 id="对象边界"><a href="#对象边界" class="header-anchor">#</a> 对象边界</h3> <p>sprite 默认没有宽高，可以给它设置 autoSize，也可以直接设置 size（会使 autoSize 失效）。</p> <p>当 sprite 内很复杂时，也就是显示列表比较多时，getBounds 需要计算边界，<strong>不是适合频繁调用（特别是设置 autoSize 时）</strong>。</p> <p>但 sprite 搭配 texture 展示图片时，必须在图片加载完的回调函数里设置 size；可以直接 <strong>使用 Texture 的宽高赋予 sprite 的宽高</strong>，这样会很高效；此时获取宽高可以使用 getGraphicsBounds（用于获取矢量绘图宽高）。</p> <h3 id="根据活动状态改变帧频"><a href="#根据活动状态改变帧频" class="header-anchor">#</a> 根据活动状态改变帧频</h3> <p>Laya.stage.frameRate=Laya.Stage.FRAME_FAST;</p> <ul><li><strong>Stage.FRAME_FAST</strong>：fast 模式，最高 FPS 为 <strong>显示器的最大帧率</strong>，如果显示器最大帧率是 60，则最大 FPS 为 60，显示器最大帧率是 120，则最大 FPS 为 120。</li> <li><strong>Stage.FRAME_SLOW</strong>：slow 模式，最高 FPS 为 <strong>显示器最大帧率的一半</strong>，在游戏运行的过程中，引擎会隔帧丢弃。如果实际可以达到 40 帧，那游戏最终帧率只是 20，如果帧率能达到 100，那最终帧只能是 50。</li> <li><strong>Stage.FRAME_MOUSE</strong>：mouse 模式则选择性在 fast 模式与 slow 模式之间 <strong>切换</strong>，有时并不需要让游戏以满帧速率执行，比如 60 帧满帧的时候，30FPS 已经能够满足多数情况下人类视觉的响应，但是鼠标交互时，30FPS 可能会造成画面的不连贯，于是 Stage.FRAME_MOUSE 应运而生。</li></ul> <h3 id="分批加载资源"><a href="#分批加载资源" class="header-anchor">#</a> 分批加载资源</h3> <p>资源 <strong>加载后</strong> 引擎就会开始 <strong>处理图片等资源</strong>，如果加载的是一张图集，会处理每张子图片，如果一次性处理大量的图片，可能会 <strong>卡顿</strong>；<br>
所以可以在游戏中 <strong>分批加载资源</strong>，以减少 CPU 的计算；
在资源使用后并且后面也不会再使用了，那就可以予以<a href="/blog-vuepress/book-web/LayaBox游戏引擎/7.性能优化.html#资源卸载">卸载</a>，释放内存。</p> <h3 id="使用-calllater"><a href="#使用-calllater" class="header-anchor">#</a> 使用 callLater</h3> <p>callLater 使代码块延迟至本帧渲染前执行。如果当前的操作频繁改变某对象的状态，此时可以考虑使用 callLater，以减少重复计算。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> rotation <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> scale <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token function">setRotation</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rotation<span class="token operator">=</span>value<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// update()改为Laya.timer.callLater(this, update);</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token function">setScale</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scale <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// update()改为Laya.timer.callLater(this, update);</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>position <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// update()改为Laya.timer.callLater(this, update);</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'rotation: '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rotation <span class="token operator">+</span> <span class="token string">'\tscale: '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scale <span class="token operator">+</span> <span class="token string">'\tposition: '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="使用节流器"><a href="#使用节流器" class="header-anchor">#</a> 使用节流器</h3> <p>节流器常用于限制鼠标频繁点击、滚动条滑动时去频繁调用 change 函数等场景</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 节流器1：先执行再延时，“相对实时”效果最好，但是最后一次关键点触发可能会被节流掉
 * fn：执行函数
 * wait：等待时间
 */</span>
<span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 节流器2：先延时再执行，有较好的“相对实时”的效果，并且最后一次触发不会被节流掉
 * fn：执行函数
 * wait：等待时间
 */</span>
<span class="token keyword">function</span> <span class="token function">throttle2</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里的this和arguments就是return function这个函数的this和arguments</span>
        <span class="token comment">//（箭头函数没有自己的this，arguments，super或new.target）</span>
        fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 节流器3：先延时后执行，“相对实时”的效果很差（定时器一直会被覆盖），但最后一次触发不会被节流
 * fn：执行函数
 * wait：等待时间
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">throttle3</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      fn <span class="token operator">&amp;&amp;</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="其它优化策略"><a href="#其它优化策略" class="header-anchor">#</a> 其它优化策略</h2> <ol><li>粒子属于矢量绘制，大量使用粒子对 CPU 压力大，在移动平台 <strong>Canvas</strong> 模式下，<strong>尽量不用粒子</strong>；WebGL 模式下可以采用 <strong>GPU 运算</strong>，能减轻 CPU 压力，但也要尽量 <strong>控制、减少使用量</strong>。</li> <li><strong>Canvas</strong> 模式尽量减少 <strong>旋转、缩放、alpha 等属性</strong> 的使用，这些属性会对性能产生消耗；如要使用，建议在 <strong>WebGL</strong> 模式下使用；</li> <li>由于 Timer 的 loop()与 frameLoop()方法里会不断的循环执行，当创建对象及复杂计算时，会导致大量的性能消耗出现在循环里，因此， <strong>尽可能不要在循环里创建对象及复杂计算</strong>。</li> <li>项目中尽量减少 try catch 的使用，<strong>被 try catch 的函数执行会变得非常慢</strong>。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-vuepress/book-web/LayaBox游戏引擎/6.屏幕适配与抗锯齿.html" class="prev">
        6.屏幕适配与抗锯齿
      </a></span> <span class="next"><a href="/blog-vuepress/book-web/常用工具/Npm的使用.html">
        Npm 的使用
      </a>
      →
    </span></p></div> </main> <div class="right-sidebar-wrapper right-sidebar-hidden"><aside class="right-sidebar"><div><div class="title">本文目录</div><h1><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#性能优化" title="性能优化">性能优化</a></h1><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#性能统计面板" title="性能统计面板">性能统计面板</a></h2><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#内存优化" title="内存优化">内存优化</a></h2><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#使用对象池优化" title="使用对象池优化">使用对象池优化</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#使用-handler-create" title="使用 Handler.create">使用 Handler.create</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#内存释放" title="内存释放">内存释放</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#资源卸载" title="资源卸载">资源卸载</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#关于滤镜、遮罩" title="关于滤镜、遮罩">关于滤镜、遮罩</a></h3><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#渲染优化" title="渲染优化">渲染优化</a></h2><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#优化-sprite" title="优化 Sprite">优化 Sprite</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#优化-drawcall" title="优化 DrawCall">优化 DrawCall</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#其他" title="其他">其他</a></h3><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#cacheas-静态缓存优化" title="CacheAs 静态缓存优化">CacheAs 静态缓存优化</a></h2><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#什么是-cacheas" title="什么是 CacheAs">什么是 CacheAs</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#cacheas-的几种缓存模式" title="CacheAs 的几种缓存模式">CacheAs 的几种缓存模式</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#测试是否频繁重绘" title="测试是否频繁重绘">测试是否频繁重绘</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#如何选择缓存模式" title="如何选择缓存模式">如何选择缓存模式</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#低端机型的配置因素" title="低端机型的配置因素">低端机型的配置因素</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#什么情况下不能使用-cacheas" title="什么情况下不能使用 cacheAs">什么情况下不能使用 cacheAs</a></h3><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#减少-cpu-使用量" title="减少 CPU 使用量">减少 CPU 使用量</a></h2><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#减少动态属性查找" title="减少动态属性查找">减少动态属性查找</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#计时器" title="计时器">计时器</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#对象边界" title="对象边界">对象边界</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#根据活动状态改变帧频" title="根据活动状态改变帧频">根据活动状态改变帧频</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#分批加载资源" title="分批加载资源">分批加载资源</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#使用-calllater" title="使用 callLater">使用 callLater</a></h3><h3><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#使用节流器" title="使用节流器">使用节流器</a></h3><h2><a href="/blog-vuepress/book-web/LayaBox%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/7.%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html#其它优化策略" title="其它优化策略">其它优化策略</a></h2></div></aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/blog-vuepress/assets/js/app.34680ebc.js" defer></script><script src="/blog-vuepress/assets/js/2.1e7adb41.js" defer></script><script src="/blog-vuepress/assets/js/42.7f4e1373.js" defer></script><script src="/blog-vuepress/assets/js/38.cec9a03e.js" defer></script>
  </body>
</html>
