<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>7.异步编程 | Liawn&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <meta charset="UTF-8">
  <link rel="icon" href="/blog-vuepress/favicon.ico">
  <link rel="manifest" href="/blog-vuepress/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/blog-vuepress/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/blog-vuepress/safari-pinned-tab.svg" color="#ffffff">
  <meta name="msapplication-TileImage" content="/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    <meta name="description" content="用vuepress搭建的个人博客">
    <meta charset="UTF-8">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog-vuepress/assets/css/0.styles.2f620dda.css" as="style"><link rel="preload" href="/blog-vuepress/assets/js/app.34680ebc.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/2.1e7adb41.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/29.392d550e.js" as="script"><link rel="preload" href="/blog-vuepress/assets/js/38.cec9a03e.js" as="script"><link rel="prefetch" href="/blog-vuepress/assets/js/10.1e723314.js"><link rel="prefetch" href="/blog-vuepress/assets/js/100.311567ba.js"><link rel="prefetch" href="/blog-vuepress/assets/js/101.ef72e26e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/102.c3759919.js"><link rel="prefetch" href="/blog-vuepress/assets/js/103.98e877a9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/104.e27de6a0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/105.3a1ef548.js"><link rel="prefetch" href="/blog-vuepress/assets/js/106.59ee0f92.js"><link rel="prefetch" href="/blog-vuepress/assets/js/107.e68abe87.js"><link rel="prefetch" href="/blog-vuepress/assets/js/108.8fcda232.js"><link rel="prefetch" href="/blog-vuepress/assets/js/109.422d008d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/11.58bde1dd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/110.f713fc26.js"><link rel="prefetch" href="/blog-vuepress/assets/js/111.58efaae4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/112.c6bdfbe0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/113.8dbd693e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/114.8a85e37a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/115.54a6972e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/116.56b2d8b8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/117.11470546.js"><link rel="prefetch" href="/blog-vuepress/assets/js/118.1a39e213.js"><link rel="prefetch" href="/blog-vuepress/assets/js/119.41f15fbd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/12.613505ee.js"><link rel="prefetch" href="/blog-vuepress/assets/js/120.9ac14643.js"><link rel="prefetch" href="/blog-vuepress/assets/js/121.83954220.js"><link rel="prefetch" href="/blog-vuepress/assets/js/122.bef8fade.js"><link rel="prefetch" href="/blog-vuepress/assets/js/123.25446ff9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/124.6acf9e60.js"><link rel="prefetch" href="/blog-vuepress/assets/js/125.42c6fb5e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/126.b9b98daa.js"><link rel="prefetch" href="/blog-vuepress/assets/js/127.382eea79.js"><link rel="prefetch" href="/blog-vuepress/assets/js/13.75740994.js"><link rel="prefetch" href="/blog-vuepress/assets/js/14.febc6ec1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/15.6e16849c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/16.70db9d99.js"><link rel="prefetch" href="/blog-vuepress/assets/js/17.f098e403.js"><link rel="prefetch" href="/blog-vuepress/assets/js/18.21ad25ae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/19.4b561714.js"><link rel="prefetch" href="/blog-vuepress/assets/js/20.8dae8a78.js"><link rel="prefetch" href="/blog-vuepress/assets/js/21.7d09e2a3.js"><link rel="prefetch" href="/blog-vuepress/assets/js/22.7838f809.js"><link rel="prefetch" href="/blog-vuepress/assets/js/23.2444198c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/24.099866db.js"><link rel="prefetch" href="/blog-vuepress/assets/js/25.d059d716.js"><link rel="prefetch" href="/blog-vuepress/assets/js/26.243af3f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/27.97e455c9.js"><link rel="prefetch" href="/blog-vuepress/assets/js/28.97ce9b54.js"><link rel="prefetch" href="/blog-vuepress/assets/js/3.49db6791.js"><link rel="prefetch" href="/blog-vuepress/assets/js/30.9161535d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/31.46b99656.js"><link rel="prefetch" href="/blog-vuepress/assets/js/32.c2fd0854.js"><link rel="prefetch" href="/blog-vuepress/assets/js/33.3080b8a5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/34.e15baec0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/35.f144a7bd.js"><link rel="prefetch" href="/blog-vuepress/assets/js/36.e1175535.js"><link rel="prefetch" href="/blog-vuepress/assets/js/37.72ec58bc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/39.fc6f4606.js"><link rel="prefetch" href="/blog-vuepress/assets/js/4.eca03551.js"><link rel="prefetch" href="/blog-vuepress/assets/js/40.b74ded47.js"><link rel="prefetch" href="/blog-vuepress/assets/js/41.cee8cec1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/42.7f4e1373.js"><link rel="prefetch" href="/blog-vuepress/assets/js/43.10c6d899.js"><link rel="prefetch" href="/blog-vuepress/assets/js/44.4f190d43.js"><link rel="prefetch" href="/blog-vuepress/assets/js/45.5c2f36ae.js"><link rel="prefetch" href="/blog-vuepress/assets/js/46.9a5337f5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/47.161b10c1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/48.93192e20.js"><link rel="prefetch" href="/blog-vuepress/assets/js/49.72ba1cc4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/5.aacc9c46.js"><link rel="prefetch" href="/blog-vuepress/assets/js/50.bfc0c26a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/51.05bbb696.js"><link rel="prefetch" href="/blog-vuepress/assets/js/52.84b5a67c.js"><link rel="prefetch" href="/blog-vuepress/assets/js/53.220715ca.js"><link rel="prefetch" href="/blog-vuepress/assets/js/54.d433d73f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/55.f8221d0f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/56.2ec79246.js"><link rel="prefetch" href="/blog-vuepress/assets/js/57.01a3b85e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/58.9015a667.js"><link rel="prefetch" href="/blog-vuepress/assets/js/59.73311086.js"><link rel="prefetch" href="/blog-vuepress/assets/js/6.0c335663.js"><link rel="prefetch" href="/blog-vuepress/assets/js/60.976cf8cc.js"><link rel="prefetch" href="/blog-vuepress/assets/js/61.4a1c95f1.js"><link rel="prefetch" href="/blog-vuepress/assets/js/62.865f814a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/63.0d882dec.js"><link rel="prefetch" href="/blog-vuepress/assets/js/64.c74f770a.js"><link rel="prefetch" href="/blog-vuepress/assets/js/65.0d5262a8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/66.1cd8fc00.js"><link rel="prefetch" href="/blog-vuepress/assets/js/67.a73db0e8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/68.2fe7b184.js"><link rel="prefetch" href="/blog-vuepress/assets/js/69.763746bf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/7.09a81cb8.js"><link rel="prefetch" href="/blog-vuepress/assets/js/70.2f10d153.js"><link rel="prefetch" href="/blog-vuepress/assets/js/71.f0476a16.js"><link rel="prefetch" href="/blog-vuepress/assets/js/72.b3aa24c4.js"><link rel="prefetch" href="/blog-vuepress/assets/js/73.d90b4378.js"><link rel="prefetch" href="/blog-vuepress/assets/js/74.5f3afc25.js"><link rel="prefetch" href="/blog-vuepress/assets/js/75.610a9393.js"><link rel="prefetch" href="/blog-vuepress/assets/js/76.397a07d0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/77.a7a16098.js"><link rel="prefetch" href="/blog-vuepress/assets/js/78.0a76e3c0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/79.d9bf3b6d.js"><link rel="prefetch" href="/blog-vuepress/assets/js/8.7a4382cf.js"><link rel="prefetch" href="/blog-vuepress/assets/js/80.6653af85.js"><link rel="prefetch" href="/blog-vuepress/assets/js/81.7bfd7632.js"><link rel="prefetch" href="/blog-vuepress/assets/js/82.e5ec57b6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/83.7728c890.js"><link rel="prefetch" href="/blog-vuepress/assets/js/84.dd67c36e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/85.7387a0e5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/86.bbfe7f7f.js"><link rel="prefetch" href="/blog-vuepress/assets/js/87.2de3f2a7.js"><link rel="prefetch" href="/blog-vuepress/assets/js/88.809122f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/89.321e8e47.js"><link rel="prefetch" href="/blog-vuepress/assets/js/9.26929067.js"><link rel="prefetch" href="/blog-vuepress/assets/js/90.5ce6c826.js"><link rel="prefetch" href="/blog-vuepress/assets/js/91.075154c5.js"><link rel="prefetch" href="/blog-vuepress/assets/js/92.11b94685.js"><link rel="prefetch" href="/blog-vuepress/assets/js/93.a9d4d5f0.js"><link rel="prefetch" href="/blog-vuepress/assets/js/94.306ece7e.js"><link rel="prefetch" href="/blog-vuepress/assets/js/95.817525f6.js"><link rel="prefetch" href="/blog-vuepress/assets/js/96.beed2305.js"><link rel="prefetch" href="/blog-vuepress/assets/js/97.b4c539f2.js"><link rel="prefetch" href="/blog-vuepress/assets/js/98.8e445314.js"><link rel="prefetch" href="/blog-vuepress/assets/js/99.558669ea.js">
    <link rel="stylesheet" href="/blog-vuepress/assets/css/0.styles.2f620dda.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><a href="/blog-vuepress/" class="home-link router-link-active"><!----> <span class="site-name">Liawn's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav></div></header> <div class="sidebar-wrapper sidebar-hidden"><aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-vuepress/book-web/" class="nav-link router-link-active">
  Web
</a></div><div class="nav-item"><a href="/blog-vuepress/book-sketches/" class="nav-link">
  生活
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><!----> <span>web前端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/" class="sidebar-heading clickable open"><span class="arrow down"></span> <span>学习JavaScript</span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/1.基础语法.html" class="sidebar-link">1.基础语法</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/2.变量、作用域和内存问题.html" class="sidebar-link">2.变量、作用域和内存问题</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/3.引用类型.html" class="sidebar-link">3.引用类型</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/4.面向对象程序设计.html" class="sidebar-link">4.面向对象程序设计</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/5.函数表达式.html" class="sidebar-link">5.函数表达式</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/6.Http、Ajax和跨域.html" class="sidebar-link">6.Http、Ajax和跨域</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html" class="active sidebar-link">7.异步编程</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/8.浏览器渲染.html" class="sidebar-link">8.浏览器的渲染</a></li><li><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/js零碎知识和案例.html" class="sidebar-link">js 部分</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习CSS/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习CSS</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/html、css、js、ts/学习TypeScript/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习TypeScript</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习Vue/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习Vue</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web前端js框架/学习React/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习React</span></a> <!----></section></li><li><a href="/blog-vuepress/book-web/web前端js框架/学习jQuery.html" class="sidebar-link">jQueryNote</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/LayaBox游戏引擎/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>H5游戏引擎Laya</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>常用工具</span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-vuepress/book-web/常用工具/Npm的使用.html" class="sidebar-link">Npm 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Git的使用.html" class="sidebar-link">Git 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/webpack的使用.html" class="sidebar-link">webpack 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/VSCode的使用.html" class="sidebar-link">VSCode 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/Chrome的使用.html" class="sidebar-link">Chrome 的使用</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用vuepress写blog.html" class="sidebar-link">使用 vuepress 写 blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用docsify写blog.html" class="sidebar-link">使用 docsify 写 blog</a></li><li><a href="/blog-vuepress/book-web/常用工具/使用gitbook写blog.html" class="sidebar-link">使用 gitbook 写 blog</a></li><li><a href="/blog-vuepress/book-web/web前端测试与调试/基于mocha+chai的单元测试.html" class="sidebar-link">使用 mocha+chai 进行单元测试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>Web后端</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web后端/学习node.js/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习node.js</span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/web后端/学习python/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>学习python</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>简单项目实践</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/项目/react+express+ts写爬虫/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>react+express+ts写爬虫</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>数据结构与算法</span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/blog-vuepress/book-web/数据结构与算法/" class="sidebar-heading clickable"><span class="arrow right"></span> <span>数据结构与算法ts版</span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>面试准备</span></p> <!----></section></li></ul> </aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div> <main class="page sidebar-hidden right-sidebar-hidden"> <div class="theme-default-content content__default"><h1 id="异步编程"><a href="#异步编程" class="header-anchor">#</a> 异步编程</h1> <h2 id="eventloop1"><a href="#eventloop1" class="header-anchor">#</a> EventLoop1</h2> <h3 id="浏览器的进程模型"><a href="#浏览器的进程模型" class="header-anchor">#</a> 浏览器的进程模型</h3> <h4 id="进程和线程"><a href="#进程和线程" class="header-anchor">#</a> 进程和线程</h4> <p>有了进程后，就可以运行程序的代码了。</p> <p>运行代码的[人]称之为[线程]。</p> <p>一个<strong>进程</strong>至少有一个<strong>线程</strong>，所以在进程开启后会自动创建一个线程来运行代码，该线程称之为<strong>主线程</strong>（主线程结束，进程就结束了）。</p> <p>如果程序需要同时执行多块代码，主线程就会启动更多的线程来执行代码，所以一个进程中可以包含多个线程。</p> <h4 id="浏览器有哪些进程和线程"><a href="#浏览器有哪些进程和线程" class="header-anchor">#</a> 浏览器有哪些进程和线程</h4> <p>浏览器是一个多进程多线程的应用程序。</p> <p>浏览器的内部工作极其复杂。</p> <p>为了避免互相影响，为了减少连环崩溃的几率，但启动浏览器后，它会自动启动多个进程。</p> <p>其中，最最要的进程有：</p> <ol><li>浏览器进程：主要负责界面显示、用户交互、子进程管理等。浏览器进程内部会启动多个线程处理不同的任务。</li> <li>网络进程：负责加载网络资源。网络进程内部会启动多个线程来处理不同的网络任务。</li> <li>渲染进程：渲染进程启动后，会开启一个<strong>渲染主线程</strong>，主线程负责执行 HTML、CSS、JS 代码。默认情况下，浏览器会为每个标签页开启一个新的渲染进程，以保证不同的标签页之间不互相影响。</li></ol> <h3 id="渲染主线程是如何工作的"><a href="#渲染主线程是如何工作的" class="header-anchor">#</a> 渲染主线程是如何工作的</h3> <p>渲染主线程是浏览器中最繁忙的线程，需要它处理的任务包括但不限于：</p> <ul><li>解析 HTML</li> <li>解析 CSS</li> <li>计算样式</li> <li>布局</li> <li>处理图层</li> <li>每秒把页面画 60 次</li> <li>执行全局 JS 代码</li> <li>执行事件处理函数</li> <li>执行计时器的回调函数</li> <li>......</li></ul> <p>要处理这么多的任务，主线程遇到了一个前所未有的难题：如何调度任务？</p> <p>比如：</p> <ul><li>我正在执行一个 JS 函数，执行到一半的时候用户点击了按钮，我该立即去执行点击事件的处理函数吗？</li> <li>我正在执行一个 JS 函数，执行到一半的时候某个计时器到达了时间，我该立即去执行它的回调吗？</li> <li>浏览器进程通知我“用户点击了按钮”，与此同时，某个计时器也到达了时间，我应该处理哪一个呢？</li></ul> <p>渲染主线程想出来一个绝妙的主意来处理这个问题：<strong>排队</strong>。</p> <p><img src="/blog-vuepress/assets/img/事件循环.c428f27b.png" alt="事件循环"></p> <ol><li>在最开始的时候，渲染主线程会进入一个无限循环</li> <li>每一次循环会检查消息队列中是否有任务存在。如果有，就取出第一个任务执行，执行完一个后进入下一次循环；如果没有，则会进入休眠状态。</li> <li>其他所有线程（包括其他进程的线程）可以随时向消息队列添加任务。新任务会加到消息队列的末尾。在添加新任务时，如果主线程是休眠状态，则会将其唤醒以继续循环拿取任务。</li></ol> <p>这样一来，就可以让每个任务有条不紊的、持续的进行下去了。</p> <p>整个过程被称为事件循环（消息循环）。</p> <h3 id="若干解释"><a href="#若干解释" class="header-anchor">#</a> 若干解释</h3> <h4 id="何为异步"><a href="#何为异步" class="header-anchor">#</a> 何为异步</h4> <p>代码在执行过程中，会遇到一些无法立即处理的任务，比如：</p> <ul><li>计时完成后需要执行的任务——<code>setTimeout</code>、<code>setInerval</code></li> <li>网络通信完成后需要执行的任务——<code>XHR</code>、<code>Fetch</code></li> <li>用户操作后需要执行的任务——<code>addEventLisetener</code></li></ul> <p>如果让渲染主线程等待这些任务的时机达到，就会导致主线程长期处于[阻塞]的状态，从而导致浏览器[卡死]。以下是同步的图示。</p> <p><img src="/blog-vuepress/assets/img/事件循环2.eca205bb.png" alt="事件循环2"></p> <p>渲染主线程承担着极其重要的工作，无论如何都不能阻塞！</p> <p>因此，浏览器选择<strong>异步</strong>来解决这个问题。以下是异步的图示。</p> <p><img src="/blog-vuepress/assets/img/事件循环3.0d0508f8.png" alt="事件循环3"></p> <p>使用异步的方式，渲染主线程永不阻塞。</p> <h4 id="面试题-如何理解-js-的异步"><a href="#面试题-如何理解-js-的异步" class="header-anchor">#</a> 面试题：如何理解 JS 的异步</h4> <p>参考答案：</p> <p>JS 是一门单线程的语言，这是因为它运行在浏览器的<strong>渲染主线程</strong>中，而渲染主线程只有一个。而渲染主线程承担着诸多工作，渲染页面、执行 JS 都在其中运行。如果使用同步的方式，就极有可能导致主线程产生阻塞，从而导致消息队列中的很多其他任务无法得到执行。这样一来，一方面会导致繁忙的主线程白白的消耗时间，另一方面导致页面无法及时更新，给用户造成卡死现象。
所以浏览器采用异步的方式来避免。具体做法是当某些任务发生时，比如计时器、网络、事件监听，主线程将任务交给其他线程去处理，自身立即结束任务的执行，转而执行后续代码。当其它线程完成时，将事先传递的回调函数包装成任务，加入到消息队列的末尾排队，等待主线程调度执行。
在这种异步模式下，浏览器永不阻塞，从而最大限度的保证了单线程的流畅运行。</p> <h4 id="js-为何会阻塞渲染"><a href="#js-为何会阻塞渲染" class="header-anchor">#</a> JS 为何会阻塞渲染</h4> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>utf-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>我是标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span><span class="token punctuation">&gt;</span></span>change<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> h1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        h1<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">&quot;标题改变了&quot;</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>点击后，<code>h1.textContent</code>被赋予新值，页面收到重绘通知并生成重绘任务放到消息队列中。继续执行下一行代码<code>delay(3000)</code>，进而遇到 3 秒钟的死循环。3 秒过后，当前任务执行完了，渲染主线程从消息队列中<strong>调度新任务</strong>来执行，那么页面重绘就会开始进行。始终记住，JS 执行和页面渲染是在同一线程也就是渲染主线程中进行的，JS 是有可能阻塞页面渲染的。</p> <h4 id="任务有优先级吗"><a href="#任务有优先级吗" class="header-anchor">#</a> 任务有优先级吗</h4> <p>任务没有优先级，在消息队列中先进先出。</p> <p><strong>但消息队列是由优先级的</strong>。</p> <p>根据 W3C 的最新解释：</p> <ul><li>每个任务都有一个任务类型，同一个类型的任务必须在一个队列，不同类型的任务可以分属于不同的队列，在一次事件循环中，浏览器可以根据实际情况从不同的队列中取出任务执行。</li> <li>浏览器必须准备好一个微队列。微队列中的任务优先所有其他任务执行。</li></ul> <p>随着浏览器的复杂度急剧提升，W3C 不再使用宏队列的说法。</p> <p>在目前的 chrome 的视线中，至少包含了下面的队列：</p> <ul><li>延时队列：用于存放计时器到达后的回调任务，优先级[中]</li> <li>交互队列：用于存放用户操作后产生的事件处理任务，优先级[高]</li> <li>微队列：用户存放需要最快执行的任务，优先级[最高]</li></ul> <p>添加任务到微队列的主要方式主要是使用<code>Promise、MutationObserver</code></p> <h4 id="面试题-阐述一下-js-的事件循环"><a href="#面试题-阐述一下-js-的事件循环" class="header-anchor">#</a> 面试题：阐述一下 JS 的事件循环</h4> <p>事件循环又叫做消息循环，是浏览器渲染主线程的工作方式。
在 Chrome 的源码中，它开启一个不会结束的 for 循环，每次循环从消息队列中取出第一个任务执行，而其他线程只需要在合适的时候将任务加入到队列末尾即可。
过去把消息队列简单分为宏队列和微队列，这种说法目前已无法满足复杂的浏览器环境，取而代之的是一种更加灵活多变的处理方式。
根据 W3C 官方的解释，每个任务有不同的类型，同类型的任务必须在同一个队列，不同的任务可以属于不同的队列。不同任务队列有不同的优先级，在一次事件循环中，由浏览器自行决定取哪一个队列的任务，但浏览器必须有一个微队列，微队列的任务一定具有最高的优先级，必须优先调度执行。</p> <h4 id="js-中的计时器能做到精确计时吗-为什么"><a href="#js-中的计时器能做到精确计时吗-为什么" class="header-anchor">#</a> JS 中的计时器能做到精确计时吗？为什么？</h4> <p>不行，因为</p> <ol><li>计算机硬件没有原子钟，无法做到精确计时</li> <li>操作系统的计时函数本身就有少量偏差，由于 JS 的计时器最终调用的是操作系统的函数，也就是携带了这些偏差。</li> <li>按照 W3C 的标准，浏览器实现计时器时，如果嵌套层级超过 5 层，则会带有 4 毫秒的最少时间，这样在计时时间少于 4 毫秒时又带来了偏差。</li> <li>受事件循环的影响，计时器的回调函数只能在主线程空闲时运行，因此又带来了偏差。</li></ol> <h2 id="eventloop2"><a href="#eventloop2" class="header-anchor">#</a> EventLoop2</h2> <blockquote><p>参考资料 1：<a href="https://html.spec.whatwg.org/multipage/webappapis.html#definitions-3" target="_blank" rel="noopener noreferrer">8 Web application APIs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
参考资料 2：<a href="https://blog.csdn.net/qq_34436866/article/details/106941350" target="_blank" rel="noopener noreferrer">跟着 whatwg 看一遍事件循环<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
参考资料 3：<a href="https://zhuanlan.zhihu.com/p/24460769" target="_blank" rel="noopener noreferrer">HTML 系列：macrotask 和 microtask<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>js 引擎是<strong>单线程</strong>运行的，同一时刻只能执行一个代码块。比如请求接口时，如果 js 引擎停下来等服务端传来响应，那就会阻塞其他代码运行。所以 js 引擎处理接口是<strong>异步</strong>的，会将接口响应任务存<strong>消息队列</strong>里然后就执行其他代码了，等后面<strong>执行栈空闲了</strong>再来处理响应任务。类似的还有定时器、侦听器等，它们可以说是<strong>异步请求同步执行</strong>，意思是请求我发给你了，但我得处理其他主要事情（异步请求）；就算你响应立马给我了，我也只是暂时排在任务列表里，手头里主要事情做完了才会去处理响应（同步处理）。</p> <p>js 引擎对这些异步操作就是使用<strong>EventLoop 事件循环</strong>来调配处理的，所用的消息队列分为<strong>task 队列</strong>和<strong>microtask 队列</strong>。EventLoop 的一个处理回合：首先会先执行<strong>task 队列</strong>中的一个任务，然后再执行<strong>microtask 队列</strong>里的<strong>所有</strong>任务，最后再根据需要与否去<strong>渲染页面</strong>。在这个回合中是同步执行的，不会出现既要处理这个任务也要处理那个任务。</p> <p>EventLoop 中<strong>task 队列</strong>可能有多个，原因是其中一个 task 队列负责优先级比较高的任务（鼠标键盘事件等），另一个 task 队列负责普通的任务（定时器等）；还有<strong>task 队列</strong>是<code>Set</code>而不是<code>Queue</code>，EventLoop 会从中取<strong>最早并且可执行</strong>的任务出来并推入执行栈中执行。比较常见的 task：<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>、<code>requestAnimationFrame</code>、<code>I/O</code>，还有类似<code>click</code>、<code>ajax</code>还有<code>&lt;script&gt;</code>标签里的代码。</p> <p>EventLoop 中<strong>microtask 队列</strong>一般只有一个，并且是<code>Queue</code>，找元素用的是<strong>出队列</strong>的方式。比较常见的 microtask：<code>Promise</code>、<code>Object.observe</code>、<code>MutationObserver</code>。</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            i <span class="token operator">==</span> <span class="token number">9999</span> <span class="token operator">&amp;&amp;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>上面这段程序在谷歌浏览器中执行的，其打印顺序就是：<code>2 4 5 3 7 9 10 8 1 6</code>。</p> <ul><li>首先两个<code>&lt;script&gt;</code>标签里代码的运行是两个 task，先添加进 task 队列里；</li> <li>从 task 队列里取可执行的 task，也就是第一个<code>&lt;script&gt;</code>标签开始执行；</li> <li>遇到<code>setTimeout</code>，将它放入 task 队列里；</li> <li>因为 Promise 内部是同步的，所以先打印<strong>2 和 4</strong>，在<code>resolve()</code>后会把 Promise 的 then 回调函数放入 microtask 队列里；</li> <li>遇到<code>console.log(5)</code>，打印完<strong>5</strong>才表示一个 task 执行完了，现在得去执行 microtask 队列<strong>所有</strong>任务；
<ul><li>microtask 队列目前就一个 then 回调函数，那么打印<strong>3</strong>，结束 microtask 队列，进入新的 task。</li></ul></li> <li>从 task 队列里取可执行的 task，也就是第二个<code>&lt;script&gt;</code>标签开始执行；</li> <li>遇到<code>setTimeout</code>，将它放入 task 队列里；</li> <li>因为 Promise 内部是同步的，所以先打印<strong>7 和 9</strong>，在<code>resolve()</code>后会把 Promise 的 then 回调函数放入 microtask 队列里；</li> <li>遇到<code>console.log(10)</code>，打印完<strong>10</strong>才表示一个 task 执行完了，现在得去执行 microtask 队列<strong>所有</strong>任务；
<ul><li>microtask 队列目前就一个 then 回调函数，那么打印<strong>8</strong>，结束 microtask 队列，进入新的 task。</li></ul></li> <li>从 task 队列里取可执行的 task，也就第一个<code>setTimeout</code>，打印<strong>1</strong>；</li> <li>从 task 队列里取可执行的 task，也就第二个<code>setTimeout</code>，打印<strong>6</strong>；</li> <li>结束了，以上省略了 UI 渲染，因为没有涉及到页面的操作。</li></ul> <p>上面这些都是说浏览器的 EventLoop，其实 node 环境中还是不一样的，<strong>node.js</strong>有用到<code>process.nextTick</code>，它并不是 EventLoop 中的一部分，它是优先于<strong>microtask</strong>执行的；还有一个<code>setImmediate</code>，是个定时器，在 I/O 操作中先于任何其他定时器的，但非 I/O 操作里<code>setImmediate</code>的先后就不一定了，比较受线程性能的影响（比如设置毫秒数是 0 到几十的时候，setTimeout 一般优于 setImmediate）。有兴趣可以查看<a href="https://nodejs.org/zh-cn/docs/guides/event-loop-timers-and-nexttick/#what-is-the-event-loop" target="_blank" rel="noopener noreferrer">Node.js 事件循环<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>上面这段程序在<strong>node</strong>中执行的，其打印顺序就是：<code>11 13 5 7 8 10 14 16 9 15 12 6 2 4 1 3</code>。具体不展开了，有时间再来扩展 node 中 EventLoop。</p> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <p>上一节后，我们对异步操作的背后有了比较清晰的认知，但这都是浏览器内部的处理，我们书写<strong>互相依赖</strong>的异步操作的时候，就非常容易形成“回调地狱”，所以后面 es6 提出了使用<strong>Promise</strong>来解决这种问题。</p> <h3 id="什么是-promise"><a href="#什么是-promise" class="header-anchor">#</a> 什么是 Promise</h3> <p><strong>Promise</strong>内存储着一个异步操作，这个异步操作要等到未来才会有结果。Promise 存储的异步操作有三种状态：<strong>pending（进行中）</strong>、<strong>fulfilled（已兑现）<strong>和</strong>rejected（已拒绝）</strong>，这三种状态就是异步操作的结果赋予的，其他人改变不了。</p> <p>还有一个经常跟 Promise 一起使用的术语：<strong>resolved（已决议）</strong>。它表示异步操作<strong>敲定好了状态</strong>，该状态可能是 fulfilled 也可能是 rejected。</p> <h3 id="调用处使用-promise"><a href="#调用处使用-promise" class="header-anchor">#</a> 调用处使用 Promise</h3> <p>未推出 Promise 时，一般做法就是回调函数会作为异步函数的<strong>入参</strong>，异步函数里的异步操作结束后会根据结果来执行对应的入参（执行回调函数）。推出 Promise 后，不会将回调函数传给异步函数，而是异步函数会<strong>返回 Promise 对象</strong>，异步操作结束后会根据结果来调用 Promise 对象的<code>then</code>中对应的回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 以前的调用：将sucFun和failFun以参数的形式传给异步函数doA，根据需要会执行sucFun和failFun</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> sucFun<span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用Promise：异步函数doA会返回一个promise对象，根据需要会执行promise对象的then方法里的sucFun和failFun</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>sucFun<span class="token punctuation">,</span> failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>.then(onFulfilled[, onRejected])</code>中第一个参数是成功回调函数，第二个参数是失败回调函数（可选参数），并且 then 会返回了一个 Promise 对象，那就可以继续使用 then，这样就会形成一种链式调用。以前接口互相依赖时采用嵌套写法，写起来非常占位置也不美观，现在使用 Promise 会非常清爽。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 以前，函数嵌套</span>
<span class="token function">doA</span><span class="token punctuation">(</span>
  data<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">doB</span><span class="token punctuation">(</span>
      rlt<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">doC</span><span class="token punctuation">(</span>
          newRlt<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          failFun
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      failFun
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  failFun
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回doB的Promise对象，好让后面继续使用链式结构</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>注意：onFulfilled 或 onRejected 执行完后，then 是返回的一个<strong>新 promise</strong>。也就是说你在 onFulfilled 或 onRejected 里自己返回一个值或者 Error 时，也是返回一个 promise，可以继续在后面写 then 这种链式调用。</p> <h3 id="promise-对象内部"><a href="#promise-对象内部" class="header-anchor">#</a> Promise 对象内部</h3> <p>上一节是说怎么使用 Promise 的方式<strong>调用异步函数</strong>，并且展示了多个异步函数时使用 Promise 方式的<strong>优势</strong>。这一节说的是异步函数内部会<strong>返回</strong>一个<strong>Promise 对象</strong>，这个过程会是一个什么样子呢？</p> <p>首先在异步函数里创建一个 Promise 对象，<code>new Promise((resolve, reject) =&gt; {})</code>；Promise 构造函数会传递一个参数，这个参数是一个<strong>executor 处理器函数</strong>，是专门用于处理具体的异步操作的；操作完异步操作当然还要通知调用方，executor 函数的两个入参<strong>resolve</strong>和<strong>reject</strong>就是专门做这些事的；当异步任务顺利完成且返回结果值时，会执行<strong>resolve</strong>方法，将 Promise 对象的状态置为<code>fulfilled</code>；而当异步任务失败且返回失败原因，会执行<strong>resolve</strong>方法，将 Promise 对象的状态置为<code>rejected</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Promise对象内部（当前小节的内容）</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 这个匿名函数其实是executor函数</span>
        <span class="token comment">/* 某某异步操作 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 操作成功 */</span><span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知操作成功，data是异步操作的结果</span>
        <span class="token keyword">else</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知操作失败，error是一个异常对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用处使用Promise（上一小节的内容）</span>
<span class="token function">doA</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接收resolve通知</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 接收reject通知</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>一个使用 Promise 封装 ajax 的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">xhr<span class="token punctuation">,</span> statusText</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="关于错误处理"><a href="#关于错误处理" class="header-anchor">#</a> 关于错误处理</h3> <p><strong>错误处理</strong>：遇到异常抛出时，会顺着 Promise 链寻找下一个<strong>onRejected</strong>失败回调函数（then 中的 onRejected），如果没有一个 onRejected，就会去<code>.catch()</code>里指定的函数里执行。可以看<a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html#调用处使用promise">调用处使用 promise</a>的第二个例子，其中有三次 failFun，但最后只用<code>.catch()</code>来处理。</p> <p>可以对错误进行精准的捕获，只是需要<strong>嵌套 Promise</strong>。下面这个例子中内部嵌套了一个 Promise，并且还带了一个 catch，这个 catch 能精准捕获到 doB 和 doC 的失败，而 doA 只会被最外层的 catch 会捕获。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">optRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="时序和拒绝事件"><a href="#时序和拒绝事件" class="header-anchor">#</a> 时序和拒绝事件</h3> <p>已经变成 resolve 状态的 Promise 对象，会通知 then()里对应的函数，这个通知传递的过程是异步的。也就是说传递到 then()中的回调函数是会被放到一个 microtask 队列里的，不过 Promise 对象里其他的执行还是同步，这就能印证<a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html#eventloop">EventLoop</a>里第一个例子中<code>2</code>和<code>4</code>为什么先于<code>3</code>打印。</p> <p><strong>拒绝事件</strong>：当 Promise 被拒绝时，如果有 reject 函数处理了，就会派发 rejectionhandled 事件到全局作用域；如果没有经过 reject 函数处理，则会派发 unhandledrejection 事件到全局作用域。两个事件都有<strong>promise</strong>属性和<strong>reason</strong>属性，其中 promise 属性是指向被驳回的 promise，reason 属性是说明被驳回的原因。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">&quot;unhandledrejection&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* 你可以在这里添加一些代码，以便检查
     event.promise 中的 promise 和
     event.reason 中的 rejection 原因 */</span>
    event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="promise-组合工具"><a href="#promise-组合工具" class="header-anchor">#</a> Promise 组合工具</h3> <p><strong>Promise.resolve(value)</strong>：手动创建一个已经 resolve 的 Promise 对象，相当于<code>new Promise(resolve =&gt; resolve(value))</code>（但不完全是，因为下一节会讲<code>new Promise(r =&gt; r(v))</code>中<code>v</code>是个 Promise 对象的情况）。</p> <p><strong>Promise.reject(value)</strong>：手动创建一个已经 reject 的 Promise 对象，相当于<code>new Promise((resolve, reject) =&gt; reject(value))</code>。</p> <p><strong>var p = Promise.all([p1, p2, p3])</strong>：all 接受一个 Promise 对象数组（也可以是 Iterator 并且返回 Promise 对象），当数组里所有的 Promise 对象状态为 fulfilled 时，p 这个 Promise 对象状态才为 fulfilled，并且结果也会组成数组传递给 p 的回调函数；当数组里只要一个被 rejected 了，那么 p 就是 rejected 状态，其结果会传递给 p 的回调函数。</p> <p><strong>var p = Promise.race([p1, p2, p3])</strong>：race 接受一个 Promise 对象数组（也可以是 Iterator 并且返回 Promise 对象），当数组里只要一个被确定状态了，那么 p 就是随之确定状态了，其结果会传递给 p 的回调函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 1.并行操作</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">,</span> result3<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2.归并，从Promise.resolve()开始执行func1再执行func2再执行func3，最后到result3</span>
<span class="token punctuation">[</span>func1<span class="token punctuation">,</span> func2<span class="token punctuation">,</span> func3<span class="token punctuation">]</span>
  <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">/* use result3 */</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3.跟上面2是一样的，直接后面追加加，上面肯定要灵活一些</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>func3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 4.其实就是用函数封装了2</span>
<span class="token keyword">const</span> <span class="token function-variable function">composeAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>funcs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> funcs<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>applyAsync<span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 5.其实就是用函数封装了3</span>
<span class="token keyword">const</span> <span class="token function-variable function">applyAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> acc<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="resolve-一个-promise-对象"><a href="#resolve-一个-promise-对象" class="header-anchor">#</a> resolve 一个 Promise 对象</h3> <p>你可能会遇到这样的问题：<code>Promise.resolve(Promise.resolve(1))</code>、<code>Promise.resolve(new Promise(r =&gt; r(1)))</code>、<code>new Promise(r =&gt; r(Promise.resolve(1)))</code>、<code>new Promise(r =&gt; r(new Promise(nr =&gt; nr(1))))</code>，这四个有什么区别？</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">r</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">nr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">nr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在控制台里打印上面的代码，会有如下结果：</p> <p><img src="data:image/png;base64,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" alt="resolve-promise"></p> <p>其实就是问<code>Promise.resolve(v)</code>和<code>new Promise(r =&gt; r(v))</code>的区别。</p> <ul><li><code>Promise.resolve(v)</code>：如果<code>v</code>是普通值，会将这个普通值包装成已经<code>fulfilled</code>的 Promise 实例；如果<code>v</code>本就是一个 Promise 实例，那就会原封不动返回<code>v</code>。</li> <li><code>new Promise(r =&gt; r(v))</code>：如果<code>v</code>是普通值，那整体会是一个已经<code>fulfilled</code>的 Promise 实例；但是如果<code>v</code>本就是一个 Promise 实例，那底层会调用<code>ResolvePromise(promise, resolution)</code>去<strong>处理</strong>，其中入参<code>promise</code>是<code>new Promise(r =&gt; r(xxx))</code>本身，入参<code>resolution</code>是<code>v</code>。具体的：
<ul><li>处理时会创建 PromiseResolveThenableJob，创建的 PromiseResolveThenableJob 会作为一个 microtask；</li> <li>然后会运行 PromiseResolveThenableJob 让<code>v</code>的 then 里的回调函数进入 microtask 队列，也就是占了一个 microtask；</li> <li>运行完后，<code>new Promise(r =&gt; r(xxx))</code>本身状态会变为<code>fulfilled</code>，那么总的来说<code>new Promise(r =&gt; r(v)</code>整体变为<code>fulfilled</code>会<strong>占用两个 microtask 时序</strong>。</li></ul></li></ul> <p>另外一个知识点，<code>then()</code>对外暴露应该是一个 Promise 对象，如果在 then 内部<code>return v;</code>，这个<code>return v;</code>要分两种情况，其实和上面的<code>new Promise(r =&gt; r(v))</code>是一样的。</p> <ul><li>如果<code>return v;</code>语句的值是一个是普通值，那 then 对外暴露的 Promise 对象其实就是将这个普通值<code>v</code>包装成已经<code>fulfilled</code>的 Promise 对象。</li> <li>如果<code>return v;</code>语句的值本就是一个 Promise 对象，那么底层会调用<code>ResolvePromise(promise, resolution)</code>处理，入参<code>promise</code>就是 then 对外暴露的 Promise 对象，resolution 就是<code>v</code>这个 Promise 对象。会经过 PromiseResolveThenableJob 的创建和运行（占用两个 microtask 时序），最后让 then 对外暴露的 Promise 对象的状态变为<code>fulfilled</code>。</li></ul> <p>为什么不直接让<code>v</code>赋给目标 Promise 对象，这样就太简单粗暴了，<code>v</code>的状态是<code>pending</code>还是<code>fulfilled</code>是不确定（即使是<code>fulfilled</code>，但它的 then 回调函数还没执行）。得使用 PromiseResolveThenableJob 来确定<code>v</code>的状态并执行它的 then 回调函数，这些走完后才能让目标 Promise 也<code>fulfilled</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 then 2 3 4</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 原封不动返回p，所以相当于p.then(v =&gt; console.log(v))，那么&quot;then&quot;会比2先打印</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 2 3 then 4</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// resolve(p)，创建PromiseResolveThenableJob会占用一个microtask</span>
<span class="token comment">// 运行PromiseResolveThenableJob，让p的then回调函数执行，这也会占用一个microtask</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 经过两个时序（打印了2和3）才打印了&quot;then&quot;</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// begin 1 test 2 3 4 then</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;then&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise.resolve(p).then相当于p.then，那么&quot;test&quot;会先于2，这个同第一个例子</span>
<span class="token comment">// 第一个then里是return Promise.resolve(v)，这会触发ResolvePromise(promise, resolution)，</span>
<span class="token comment">// promise入参是代表第一个then的promise，resolution入参是v。跟上一个例子一样要占用两个micrtask时序</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 其实如果是return v;那就不会触发ResolvePromise了</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 但是比上一例子多了一个then，那么&quot;then&quot;会在4后面打印了</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div> <p>参考资料：</p> <ul><li><a href="https://chromium.googlesource.com/v8/v8.git/+/refs/heads/9.0-lkgr/src/builtins/promise-resolve.tq#88" target="_blank" rel="noopener noreferrer">关于 ResolvePromise<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>至于 PromiseResolveThenableJob 为什么会消耗两个 micrtask 可以看<a href="https://www.zhihu.com/question/430549238/answer/1624864911" target="_blank" rel="noopener noreferrer">resolve(resolvedPromise)情况源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章。</li></ul> <h2 id="async-和-await"><a href="#async-和-await" class="header-anchor">#</a> async 和 await</h2> <h3 id="简单使用-async-和-await"><a href="#简单使用-async-和-await" class="header-anchor">#</a> 简单使用 async 和 await</h3> <p><strong>async</strong>和<strong>await</strong>的搭配使用，可以写出更简洁的基于 Promise 的异步行为。async 用来修饰函数表示函数中即将使用 await 表达式，async 函数一定会返回一个 promise 对象（就算没有也会被 Promise.resolve 转换）；await 用于暂停整个 async 函数的执行进程并出让其控制权，只有当其等待的基于 promise 的异步操作被兑现或被拒绝之后才会恢复进程；其实 await 可以用于普通函数，也就是 await 等到的是一个普通值，它就是不会让出控制权（不阻塞后面的代码）。基本语法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>param<span class="token punctuation">[</span><span class="token punctuation">,</span> param<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span> param<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    statements <span class="token comment">// 0个或者多个await表达式</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们来使用<strong>async</strong>和<strong>await</strong>重写之前 Promise 的例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回doB的Promise对象，好让后面继续使用链式结构</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用async和await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> finRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doC</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>failFun<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>改写精准的错误捕获例子</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 使用Promise，链式</span>
<span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">optRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">newRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">finRlt</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>failFun<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 使用async和await</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> rlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> optRlt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> newRlt <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      optRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doB</span><span class="token punctuation">(</span>rlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doC</span><span class="token punctuation">(</span>optRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> finRlt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">doD</span><span class="token punctuation">(</span>newRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;FinalResult:&quot;</span><span class="token punctuation">,</span> finRlt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>failFun<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="async-和-await-相关执行顺序"><a href="#async-和-await-相关执行顺序" class="header-anchor">#</a> async 和 await 相关执行顺序</h3> <p>我们先看一下 EventLoop、Promise、async/await 等结合起来的题目：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// await &quot;2&quot;，会转换为await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
  <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
  <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 2 3 7 4</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// await Promise.resolve(&quot;2&quot;)，状态是`fulfilled`</span>
  <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 输出依次为5 1 6 7 2 3 4</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// testSometing()里用了async标识，并且返回是`return Promise.resolve(&quot;2&quot;)`</span>
  <span class="token comment">// 这会导致要经过ResolvePromise(promise, resolution)的处理，入参promise是</span>
  <span class="token comment">// testSometing()对外暴露的Promise对象，入参resolution是Promise.resolve(&quot;2&quot;)</span>
  <span class="token comment">// 处理完后`await testSometing()`这里才`fulfilled`，那么`7`会先于`2`打印</span>
  <span class="token keyword">const</span> v1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testSometing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> v2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;6&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div> <p>要解释上面这些例子必须先弄懂<strong>不带</strong>async/await 的异步执行顺序问题，也就是<a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/7.异步编程.html#resolve一个promise对象">resolve 一个 Promise 对象</a>的内容。</p> <p>然后还要知道 async 函数的对外暴露的得是一个 Promise 对象，如果在 sync 函数内部<code>return v;</code>，它的处理和<code>then()</code>一样：</p> <ul><li>如果<code>return v;</code>语句的值是一个是普通值，那 async 函数的对外暴露的 Promise 对象其实就是将这个普通值<code>v</code>包装成已经<code>fulfilled</code>的 Promise 对象。</li> <li>如果<code>return v;</code>语句的值本就是一个 Promise 对象，那么底层会调用<code>ResolvePromise(promise, resolution)</code>处理，入参<code>promise</code>就是 async 函数的对外暴露的 Promise 对象，入参<code>resolution</code>就是<code>v</code>这个 Promise 对象。会经过 PromiseResolveThenableJob 的创建和运行（占用两个 microtask 时序），最后让 async 函数的对外暴露的 Promise 对象的状态变为<code>fulfilled</code>。</li></ul> <p>最后还要知道 await 等到的值是普通值是会被<code>Promise.resolve()</code>进行隐式转换（转换后是<code>fulfilled</code>的）。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/6.Http、Ajax和跨域.html" class="prev">
        6.Http、Ajax和跨域
      </a></span> <span class="next"><a href="/blog-vuepress/book-web/html、css、js、ts/学习JavaScript/8.浏览器渲染.html">
        8.浏览器的渲染
      </a>
      →
    </span></p></div> </main> <div class="right-sidebar-wrapper right-sidebar-hidden"><aside class="right-sidebar"><div><div class="title">本文目录</div><h1><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#异步编程" title="异步编程">异步编程</a></h1><h2><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#eventloop1" title="EventLoop1">EventLoop1</a></h2><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#浏览器的进程模型" title="浏览器的进程模型">浏览器的进程模型</a></h3><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#进程和线程" title="进程和线程">进程和线程</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#浏览器有哪些进程和线程" title="浏览器有哪些进程和线程">浏览器有哪些进程和线程</a></h4><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#渲染主线程是如何工作的" title="渲染主线程是如何工作的">渲染主线程是如何工作的</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#若干解释" title="若干解释">若干解释</a></h3><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#何为异步" title="何为异步">何为异步</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#面试题-如何理解-js-的异步" title="面试题：如何理解 JS 的异步">面试题：如何理解 JS 的异步</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#js-为何会阻塞渲染" title="JS 为何会阻塞渲染">JS 为何会阻塞渲染</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#任务有优先级吗" title="任务有优先级吗">任务有优先级吗</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#面试题-阐述一下-js-的事件循环" title="面试题：阐述一下 JS 的事件循环">面试题：阐述一下 JS 的事件循环</a></h4><h4><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#js-中的计时器能做到精确计时吗-为什么" title="JS 中的计时器能做到精确计时吗？为什么？">JS 中的计时器能做到精确计时吗？为什么？</a></h4><h2><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#eventloop2" title="EventLoop2">EventLoop2</a></h2><h2><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#promise" title="Promise">Promise</a></h2><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#什么是-promise" title="什么是 Promise">什么是 Promise</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#调用处使用-promise" title="调用处使用 Promise">调用处使用 Promise</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#promise-对象内部" title="Promise 对象内部">Promise 对象内部</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#关于错误处理" title="关于错误处理">关于错误处理</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#时序和拒绝事件" title="时序和拒绝事件">时序和拒绝事件</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#promise-组合工具" title="Promise 组合工具">Promise 组合工具</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#resolve-一个-promise-对象" title="resolve 一个 Promise 对象">resolve 一个 Promise 对象</a></h3><h2><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#async-和-await" title="async 和 await">async 和 await</a></h2><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#简单使用-async-和-await" title="简单使用 async 和 await">简单使用 async 和 await</a></h3><h3><a href="/blog-vuepress/book-web/html%E3%80%81css%E3%80%81js%E3%80%81ts/%E5%AD%A6%E4%B9%A0JavaScript/7.%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B.html#async-和-await-相关执行顺序" title="async 和 await 相关执行顺序">async 和 await 相关执行顺序</a></h3></div></aside> <div class="sidebar-toggle" data-v-10bfdc0c><div class="sidebar-toggle-button" data-v-10bfdc0c><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span><span data-v-10bfdc0c></span></div></div></div></div><div class="global-ui"><!----></div></div>
    <script src="/blog-vuepress/assets/js/app.34680ebc.js" defer></script><script src="/blog-vuepress/assets/js/2.1e7adb41.js" defer></script><script src="/blog-vuepress/assets/js/29.392d550e.js" defer></script><script src="/blog-vuepress/assets/js/38.cec9a03e.js" defer></script>
  </body>
</html>
